<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #f0f2f7;
            --white: #fff;
            --blue: #3b6ef8;
            --blue-l: #eef1ff;
            --dark: #1a1d2e;
            --mid: #6b7080;
            --muted: #a0a5b8;
            --border: #e8ebf5;
            --red: #ef4444
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: var(--dark)
        }

        .sidebar {
            width: 60px;
            background: var(--white);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px 0;
            gap: 4px;
            border-right: 1px solid var(--border);
            z-index: 10;
            flex-shrink: 0
        }

        .sb-logo {
            width: 36px;
            height: 36px;
            background: var(--blue);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 14px
        }

        .sb-logo svg {
            width: 18px;
            height: 18px;
            fill: #fff
        }

        .sb-icon {
            width: 38px;
            height: 38px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--muted);
            transition: .15s
        }

        .sb-icon:hover,
        .sb-icon.active {
            background: var(--blue-l);
            color: var(--blue)
        }

        .sb-icon svg {
            width: 17px;
            height: 17px
        }

        .sb-div {
            width: 30px;
            height: 1px;
            background: var(--border);
            margin: 8px 0
        }

        .sb-btm {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px
        }

        .sb-av {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f97316, #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            cursor: pointer
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden
        }

        .topnav {
            height: 52px;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0
        }

        .bc {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--mid)
        }

        .bc a {
            color: var(--mid);
            text-decoration: none
        }

        .bc a:hover {
            color: var(--blue)
        }

        .bc .sep {
            color: var(--muted)
        }

        .bc .cur {
            color: var(--dark);
            font-weight: 500
        }

        .nav-r {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .ib {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--mid);
            transition: .15s
        }

        .ib:hover {
            border-color: var(--blue);
            color: var(--blue)
        }

        .ib svg {
            width: 15px;
            height: 15px
        }

        .ib.disabled {
            opacity: 0.3;
            pointer-events: none;
            cursor: default;
        }

        .ib.danger {
            color: var(--red);
        }

        .ib.danger:hover {
            background: #fee2e2;
            border-color: var(--red);
            color: var(--red);
        }

        .pub {
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 9px;
            padding: 9px 18px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: .15s
        }

        .pub:hover {
            background: #2b5ce6
        }

        .tog-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 9px;
            border: 1.5px solid var(--border);
            background: var(--white);
            cursor: pointer;
            color: var(--mid)
        }

        .tog-btn svg {
            width: 16px;
            height: 16px
        }

        .mob-bar {
            display: none;
            overflow-x: auto;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 0 10px;
            flex-shrink: 0;
            scrollbar-width: none
        }

        .mob-bar::-webkit-scrollbar {
            display: none
        }

        .mob-inner {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 6px 0;
            width: max-content
        }

        .mi {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 7px 12px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--muted);
            transition: .15s;
            white-space: nowrap;
            min-width: 56px;
            flex-shrink: 0
        }

        .mi:hover,
        .mi.active {
            background: var(--blue-l);
            color: var(--blue)
        }

        .mi svg {
            width: 18px;
            height: 18px
        }

        .mi span {
            font-size: 10px;
            font-weight: 600
        }

        .mi-sep {
            width: 1px;
            height: 28px;
            background: var(--border);
            margin: 0 4px;
            flex-shrink: 0
        }

        .mi-av {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f97316, #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            flex-shrink: 0
        }

        .content {
            flex: 1;
            display: flex;
            overflow: hidden
        }

        .canvas {
            flex: 1;
            overflow: auto;
            position: relative;
            background: radial-gradient(circle, #d0d4e0 1px, transparent 1px) var(--bg);
            background-size: 24px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            scrollbar-width: thin;
        }

        /* Float Zoom Controls */
        .zoom-ctrl {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            border-radius: 12px;
            padding: 5px;
            display: flex;
            align-items: center;
            gap: 2px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, .12);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .zc-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: none;
            color: var(--mid);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .15s;
        }

        .zc-btn:hover {
            background: var(--blue-l);
            color: var(--blue);
        }

        .zc-btn svg {
            width: 16px;
            height: 16px;
        }

        .zc-val {
            min-width: 50px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--dark);
            user-select: none;
        }

        .zc-sep {
            width: 1px;
            height: 18px;
            background: var(--border);
            margin: 0 4px;
        }

        .canvas-empty {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
            text-align: center;
            pointer-events: all;
            cursor: pointer
        }

        .ce-icon {
            width: 60px;
            height: 60px;
            border: 2px dashed var(--border);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .ce-icon svg {
            width: 26px;
            height: 26px;
            color: var(--muted)
        }

        .canvas-empty h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--mid)
        }

        .canvas-empty p {
            font-size: 12px;
            color: var(--muted);
            max-width: 220px;
            line-height: 1.6
        }

        .canvas-empty strong {
            color: var(--blue)
        }

        .layer-wrap {
            display: none;
            flex-direction: column;
            align-items: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%)
        }

        .layer-wrap.vis {
            display: flex
        }

        .c-layer {
            background: #fff;
            border: none;
            border-radius: 4px;
            position: relative;
            overflow: visible;
            box-shadow: 0 8px 32px rgba(0, 0, 0, .1);
            flex-shrink: 0
        }

        /* Inner content clip — keeps images/text inside the white canvas */
        .c-layer::before {
            content: '';
            position: absolute;
            inset: 0;
            background: #fff;
            border-radius: 4px;
            z-index: 0;
        }

        .lc {
            display: none;
        }

        .l-sel {
            display: none;
        }

        .layer-img-grid {
            position: absolute;
            inset: 0;
            overflow: hidden;
            /* Clips images/text inside the white canvas */
        }

        .layer-handle-ov {
            position: absolute;
            inset: 0;
            overflow: visible;
            pointer-events: none;
            z-index: 20;
        }

        .layer-handle-ov .lh-ghost {
            position: absolute;
            pointer-events: none;
        }

        .layer-handle-ov .lh-ghost .lg-h-wrap {
            pointer-events: none;
        }

        .layer-handle-ov .lh-ghost .rh {
            pointer-events: all;
        }

        .layer-handle-ov .lh-ghost .lg-ring {
            pointer-events: none;
        }

        .lg-item {
            position: absolute;
            overflow: visible;
            min-height: 0;
            min-width: 0;
            cursor: grab;
            user-select: none;
            pointer-events: all;
            transform-origin: center center;
            will-change: transform;
        }

        .lg-item.dragging {
            cursor: grabbing;
            z-index: 100 !important;
        }

        /* .lg-item.selected: z-index is set dynamically by JS (500), others get their array index */

        /* Pointer events are handled specifically for each layer type in JS */

        /* crop viewport — clips the image; panning/zoom happen inside */
        .lg-crop {
            position: absolute;
            inset: 0;
            overflow: hidden;
            /* Clip images to the layer boundary */
        }

        .lg-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: none;
            pointer-events: none;
        }

        .lg-item .lg-text-node {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: none;
            pointer-events: none;
        }

        .lg-item .lg-num {
            display: none;
        }

        .lg-item .lg-lbl {
            display: none;
        }

        /* selection border */
        .lg-item .lg-ring {
            position: absolute;
            inset: 0;
            border: 2px solid var(--blue);
            pointer-events: none;
            opacity: 0;
            z-index: 5
        }

        .lg-item.selected .rh,
        .lg-item.selected .lg-ring {
            opacity: 1
        }

        .lg-h-wrap {
            position: absolute;
            inset: -4px;
            pointer-events: none;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .lg-item.selected .lg-h-wrap {
            opacity: 1;
        }

        .lg-h-wrap .rh,
        .lg-h-wrap .lg-ring {
            opacity: 1;
            pointer-events: all;
        }

        /* handles relative to the wrapper */
        .rh {
            position: absolute;
            width: 34px;
            height: 34px;
            background: #fff;
            border: 2px solid var(--border);
            border-radius: 50%;
            z-index: 25;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .rh:hover {
            transform: translate(-50%, -50%) scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-color: var(--blue);
        }

        .rh svg {
            width: 14px;
            height: 14px;
            pointer-events: none;
        }

        .rh.tl {
            top: 0;
            left: 0;
            background: #ff4b2b;
            color: #fff;
            border-color: #ff4b2b;
            cursor: pointer;
        }

        .rh.tl:hover {
            background: #e03e20;
            border-color: #e03e20;
        }

        .rh.tr {
            top: 0;
            left: 100%;
            cursor: move;
        }

        .rh.bl {
            top: 100%;
            left: 0;
            cursor: alias;
            /* rotate cursor */
        }

        .rh.br {
            top: 100%;
            left: 100%;
            cursor: nwse-resize;
        }

        /* Hide old handles that might still be in code */
        .rh.tc,
        .rh.bc,
        .rh.ml,
        .rh.mr,
        .rh.rot {
            display: none !important;
        }



        .text-mode-active #canvas {
            cursor: text !important;
        }

        .lg-text-node {
            outline: none;
            cursor: text;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .lg-text-node.notepad {
            background-image: linear-gradient(rgba(var(--blue-rgb), 0.1) 1px, transparent 1px);
            background-size: 100% var(--lh-px);
            background-position: 0 calc(var(--lh-px) - 1px);
            background-attachment: local;
        }

        .lg-text-node:focus {
            background-color: rgba(var(--blue-rgb), 0.08);
            /* Slightly deeper highlight */
            box-shadow: 0 0 0 2px var(--blue);
            border-radius: 4px;
            caret-color: var(--blue);
            /* Ensure the blinker/cursor matches the theme */
        }

        .layer-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            pointer-events: none;
            color: var(--muted)
        }

        .layer-placeholder svg {
            width: 32px;
            height: 32px
        }

        .layer-placeholder p {
            font-size: 12px;
            text-align: center;
            padding: 0 16px;
            line-height: 1.5
        }

        /* ── RIGHT PANEL ── */
        .rpanel {
            width: 300px;
            background: var(--white);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0
        }

        .rp-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0
        }

        .rp-tab {
            flex: 1;
            padding: 11px 4px;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            text-align: center;
            border-bottom: 2.5px solid transparent;
            transition: .15s;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px
        }

        .rp-tab svg {
            width: 12px;
            height: 12px;
            flex-shrink: 0
        }

        .rp-tab:hover {
            color: var(--dark)
        }

        .rp-tab.on {
            color: var(--blue);
            border-bottom-color: var(--blue)
        }

        .rp-view {
            flex: 1;
            overflow-y: auto;
            display: none;
            flex-direction: column
        }

        .rp-view.on {
            display: flex
        }

        /* layers list */
        .lv-hdr {
            padding: 12px 14px 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .lv-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--dark)
        }

        .lv-add {
            width: 26px;
            height: 26px;
            border-radius: 7px;
            background: var(--blue-l);
            border: none;
            color: var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: .15s
        }

        .lv-add:hover {
            background: var(--blue);
            color: #fff
        }

        .lv-add svg {
            width: 13px;
            height: 13px
        }

        .lv-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px
        }

        .lv-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 40px 16px;
            text-align: center;
            color: var(--muted)
        }

        .lv-empty svg {
            width: 30px;
            height: 30px;
            opacity: .4
        }

        .lv-empty p {
            font-size: 11px;
            line-height: 1.5
        }

        .lv-item {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 8px 9px;
            border-radius: 10px;
            cursor: pointer;
            transition: .15s;
            border: 1.5px solid transparent;
            margin-bottom: 4px
        }

        .lv-item:hover {
            background: #f7f8fc
        }

        .lv-item.active {
            background: var(--blue-l);
            border-color: rgba(59, 110, 248, .22)
        }

        .lv-thumb {
            width: 42px;
            height: 32px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: #e8ebf5;
            border: 1px solid var(--border)
        }

        .lv-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .lv-info {
            flex: 1;
            min-width: 0
        }

        .lv-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .lv-meta {
            font-size: 10px;
            color: var(--muted);
            margin-top: 1px
        }

        .lv-acts {
            display: flex;
            gap: 2px;
            flex-shrink: 0
        }

        .lv-act {
            width: 22px;
            height: 22px;
            border-radius: 5px;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .15s
        }

        .lv-act:hover.vis-btn {
            color: var(--blue)
        }

        .lv-act:hover.del-btn {
            color: var(--red)
        }

        .lv-act svg {
            width: 12px;
            height: 12px
        }

        /* no-selection message */
        .no-sel-msg {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 50px 20px;
            text-align: center;
            color: var(--muted);
            flex: 1
        }

        .no-sel-msg svg {
            width: 34px;
            height: 34px;
            opacity: .35
        }

        .no-sel-msg p {
            font-size: 11px;
            line-height: 1.6
        }

        /* prop sections */
        .ps {
            padding: 16px 18px;
            border-bottom: 3px solid var(--bg);
            transition: all 0.2s;
        }

        .ps:hover {
            background: #fafbff;
        }

        .ps-lbl {
            font-size: 11px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 7px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .ps-lbl svg {
            width: 14px;
            height: 14px;
            color: var(--blue);
            stroke-width: 2.5;
        }

        /* image preview */
        .img-prev {
            width: 100%;
            height: 100px;
            border-radius: 9px;
            overflow: hidden;
            position: relative;
            background: #e8ebf5;
            margin-bottom: 8px
        }

        .img-prev img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .img-prev-ov {
            position: absolute;
            inset: 0;
            background: linear-gradient(transparent 55%, rgba(0, 0, 0, .45));
            display: flex;
            align-items: flex-end;
            padding: 7px 9px
        }

        .img-prev-name {
            font-size: 10px;
            font-weight: 600;
            color: #fff
        }

        .repl-btn {
            width: 100%;
            padding: 7px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: none;
            color: var(--mid);
            font-size: 11px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: .15s
        }

        .repl-btn:hover {
            border-color: var(--blue);
            color: var(--blue);
            background: var(--blue-l)
        }

        .repl-btn svg {
            width: 12px;
            height: 12px
        }

        /* transform grid */
        .tc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px
        }

        .tc-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 4px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: none;
            cursor: pointer;
            color: var(--mid);
            font-family: inherit;
            font-size: 9px;
            font-weight: 700;
            transition: .15s;
            letter-spacing: .03em;
            text-transform: uppercase
        }

        .tc-btn svg {
            width: 15px;
            height: 15px
        }

        .tc-btn:hover {
            border-color: var(--blue);
            color: var(--blue);
            background: var(--blue-l)
        }

        .tc-btn.on {
            background: var(--blue-l);
            border-color: var(--blue);
            color: var(--blue)
        }

        .tc-full {
            grid-column: span 2
        }

        /* Palette */
        .pal-col {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), border-color 0.2s;
        }

        .pal-col:hover {
            transform: scale(1.2);
            z-index: 2;
            border-color: var(--blue) !important;
        }

        .pal-col:active {
            transform: scale(0.95);
        }

        /* sliders */
        .sl-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
        }

        .sl-hdr {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sl-lbl {
            font-size: 11px;
            color: var(--mid);
            font-weight: 600;
        }

        .sl-val {
            background: var(--bg);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            color: var(--blue);
            min-width: 45px;
            text-align: center;
        }

        .sl-ctrl {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        input[type=range].sl {
            flex: 1;
            height: 6px;
            border-radius: 10px;
            appearance: none;
            outline: none;
            border: none;
            cursor: pointer;
            background: var(--border);
            transition: all 0.2s;
        }

        input[type=range].sl:hover {
            background: #e2e8f0;
        }

        input[type=range].sl::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid var(--blue);
            box-shadow: 0 2px 6px rgba(59, 110, 248, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type=range].sl::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 8px rgba(59, 110, 248, 0.4);
        }

        /* number inputs */
        .ni-row {
            display: flex;
            gap: 5px;
            margin-bottom: 7px
        }

        .ni-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px
        }

        .ni-lbl {
            font-size: 9px;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: .05em;
            text-transform: uppercase
        }

        .ni-inp {
            width: 100%;
            border: 1.5px solid var(--border);
            border-radius: 7px;
            padding: 6px 6px;
            font-size: 11px;
            font-family: inherit;
            color: var(--dark);
            outline: none;
            text-align: center;
            transition: .15s
        }

        .ni-inp:focus {
            border-color: var(--blue)
        }

        /* delete zone */
        .del-zone {
            padding: 10px 14px 14px;
            flex-shrink: 0
        }

        .del-btn-full {
            width: 100%;
            padding: 9px;
            border: 1.5px solid #fca5a5;
            border-radius: 9px;
            background: #fee2e2;
            color: var(--red);
            font-size: 11px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: .15s
        }

        .del-btn-full:hover {
            background: var(--red);
            color: #fff;
            border-color: var(--red)
        }

        .del-btn-full svg {
            width: 13px;
            height: 13px
        }

        /* crop button in properties */
        .crop-open-btn {
            width: 100%;
            padding: 8px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: none;
            color: var(--mid);
            font-size: 11px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: .15s
        }

        .crop-open-btn:hover {
            border-color: var(--blue);
            color: var(--blue);
            background: var(--blue-l)
        }

        .crop-open-btn svg {
            width: 13px;
            height: 13px
        }

        .crop-reset-btn {
            flex: 0 0 auto;
            padding: 7px 10px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: none;
            color: var(--muted);
            font-size: 10px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: .15s
        }

        .crop-reset-btn:hover {
            border-color: var(--red);
            color: var(--red)
        }

        .crop-reset-btn svg {
            width: 11px;
            height: 11px
        }

        .crop-btn-row {
            display: flex;
            gap: 6px;
            align-items: center
        }

        .crop-btn-row .crop-open-btn {
            flex: 1
        }

        /* ── CROP MODAL ── */
        #cropOv {
            position: fixed;
            inset: 0;
            background: rgba(8, 10, 25, .72);
            backdrop-filter: blur(14px);
            z-index: 9600;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s, visibility .3s;
            padding: 16px
        }

        #cropOv.show {
            opacity: 1;
            visibility: visible
        }

        .crop-modal {
            background: #fff;
            border-radius: 22px;
            width: 100%;
            max-width: 680px;
            box-shadow: 0 32px 80px rgba(0, 0, 0, .3);
            overflow: hidden;
            transform: translateY(28px) scale(.96);
            transition: transform .38s cubic-bezier(.34, 1.2, .64, 1)
        }

        #cropOv.show .crop-modal {
            transform: translateY(0) scale(1)
        }

        .crop-m-hdr {
            padding: 18px 22px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .crop-m-hdr-l {
            display: flex;
            align-items: center;
            gap: 11px
        }

        .crop-m-ico {
            width: 38px;
            height: 38px;
            border-radius: 11px;
            background: var(--blue-l);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue)
        }

        .crop-m-ico svg {
            width: 18px;
            height: 18px
        }

        .crop-m-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--dark)
        }

        .crop-m-sub {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px
        }

        .crop-m-x {
            width: 32px;
            height: 32px;
            border-radius: 9px;
            border: 1.5px solid var(--border);
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid);
            transition: .15s
        }

        .crop-m-x:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #ef4444
        }

        .crop-m-x svg {
            width: 13px;
            height: 13px
        }

        /* aspect ratio pills */
        .crop-ar-row {
            display: flex;
            gap: 6px;
            padding: 12px 22px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            scrollbar-width: none;
            flex-wrap: wrap
        }

        .crop-ar-row::-webkit-scrollbar {
            display: none
        }

        .car {
            padding: 5px 13px;
            border-radius: 20px;
            border: 1.5px solid var(--border);
            background: #fff;
            font-size: 11px;
            font-weight: 600;
            color: var(--mid);
            cursor: pointer;
            white-space: nowrap;
            transition: .15s;
            font-family: inherit
        }

        .car:hover {
            border-color: var(--blue);
            color: var(--blue)
        }

        .car.on {
            background: var(--blue);
            border-color: var(--blue);
            color: #fff
        }

        /* canvas area */
        .crop-canvas-area {
            padding: 18px 22px;
            display: flex;
            flex-direction: column;
            gap: 14px
        }

        .crop-preview-wrap {
            position: relative;
            width: 100%;
            background: #1a1d2e;
            border-radius: 12px;
            overflow: hidden;
            user-select: none;
            min-height: 220px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #cropPreviewImg {
            display: block;
            max-width: 100%;
            max-height: 320px;
            object-fit: contain;
            pointer-events: none;
            border-radius: 8px
        }

        /* dark overlay outside crop box */
        .crop-shade {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: rgba(0, 0, 0, .55);
            z-index: 1
        }

        /* the crop selection box */
        #cropBox {
            position: absolute;
            border: 2px solid var(--blue);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, .52);
            z-index: 2;
            cursor: move;
            border-radius: 2px
        }

        .crop-corner {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border: 2px solid var(--blue);
            border-radius: 3px;
            z-index: 3;
            box-shadow: 0 1px 5px rgba(0, 0, 0, .3)
        }

        .crop-corner.tl {
            top: -6px;
            left: -6px;
            cursor: nw-resize
        }

        .crop-corner.tr {
            top: -6px;
            right: -6px;
            cursor: ne-resize
        }

        .crop-corner.bl {
            bottom: -6px;
            left: -6px;
            cursor: sw-resize
        }

        .crop-corner.br {
            bottom: -6px;
            right: -6px;
            cursor: se-resize
        }

        .crop-edge {
            position: absolute;
            background: rgba(255, 255, 255, .7);
            border-radius: 4px;
            z-index: 3
        }

        .crop-edge.et {
            top: -2px;
            left: 30%;
            right: 30%;
            height: 4px;
            cursor: n-resize
        }

        .crop-edge.eb {
            bottom: -2px;
            left: 30%;
            right: 30%;
            height: 4px;
            cursor: s-resize
        }

        .crop-edge.el {
            left: -2px;
            top: 30%;
            bottom: 30%;
            width: 4px;
            cursor: w-resize
        }

        .crop-edge.er {
            right: -2px;
            top: 30%;
            bottom: 30%;
            width: 4px;
            cursor: e-resize
        }

        /* grid lines inside crop */
        .crop-grid {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 2;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr
        }

        .crop-grid-cell {
            border: 1px solid rgba(255, 255, 255, .18)
        }

        /* manual inputs */
        .crop-manual-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        .crop-inp-group {
            display: flex;
            flex-direction: column;
            gap: 4px
        }

        .crop-inp-lbl {
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: .05em;
            text-transform: uppercase
        }

        .crop-inp {
            width: 100%;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            font-family: inherit;
            color: var(--dark);
            outline: none;
            transition: .15s;
            text-align: center
        }

        .crop-inp:focus {
            border-color: var(--blue)
        }

        /* ── DOC MODE MODAL ── */
        #docModeOv {
            position: fixed;
            inset: 0;
            background: rgba(8, 10, 25, 0.6);
            backdrop-filter: blur(8px);
            z-index: 9700;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        #docModeOv.show {
            display: flex;
            opacity: 1;
        }

        .doc-modal {
            background: #fff;
            width: 100%;
            max-width: 900px;
            height: 90vh;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 40px 120px rgba(0, 0, 0, 0.5);
            transform: scale(0.95) translateY(20px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #docModeOv.show .doc-modal {
            transform: scale(1) translateY(0);
        }

        .doc-m-hdr {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
        }

        .doc-m-title-wrap {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .doc-m-icon {
            width: 42px;
            height: 42px;
            background: var(--blue-l);
            color: var(--blue);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .doc-m-icon svg {
            width: 22px;
            height: 22px;
        }

        .doc-m-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }

        .doc-m-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }

        .doc-m-body {
            background: radial-gradient(circle at center, #f8fafc 0%, #edf2f7 100%);
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .doc-sheet {
            background: #fff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            padding: 60px 80px;
            outline: none;
            font-size: 18px;
            line-height: 1.6;
            color: #2e3e4e;
            cursor: text;
            white-space: pre-wrap;
            word-break: break-word;
            display: block;
            margin: auto;
            max-width: 95%;
            max-height: 95%;
        }

        /* Ensure split color applies to nested elements (spans from rich text) */
        .doc-sheet.split-on *,
        .lg-text-node.split-on * {
            color: transparent !important;
            -webkit-text-fill-color: transparent !important;
            background: transparent !important;
        }

        .doc-m-ftr {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            background: #fff;
        }

        .doc-btn {
            padding: 11px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .doc-btn-cancel {
            background: #fff;
            border: 1.5px solid #e2e8f0;
            color: #64748b;
        }

        .doc-btn-cancel:hover {
            border-color: var(--muted);
            color: var(--dark);
            background: #f8fafc;
        }

        .doc-btn-apply {
            background: var(--blue);
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 25px rgba(59, 110, 248, 0.25);
        }

        .doc-btn-apply:hover {
            background: #2b5ce6;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 110, 248, 0.4);
        }

        .doc-btn-apply svg {
            width: 16px;
            height: 16px;
        }

        .crop-inp-hint {
            font-size: 10px;
            color: var(--muted)
        }

        .crop-m-ftr {
            padding: 12px 22px 18px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end
        }

        .crop-cancel {
            padding: 9px 20px;
            border: 1.5px solid var(--border);
            border-radius: 9px;
            background: none;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            color: var(--mid);
            cursor: pointer;
            transition: .15s
        }

        .crop-cancel:hover {
            border-color: var(--mid);
            color: var(--dark)
        }

        .crop-apply {
            padding: 9px 24px;
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 9px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: .15s
        }

        .crop-apply:hover {
            background: #2b5ce6
        }

        .crop-apply svg {
            width: 14px;
            height: 14px
        }

        /* modals */
        .m-ov {
            position: fixed;
            inset: 0;
            background: rgba(15, 18, 35, .45);
            backdrop-filter: blur(5px);
            z-index: 8000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s, visibility .3s;
            padding: 16px
        }

        .m-ov.show {
            opacity: 1;
            visibility: visible
        }

        .sm {
            background: #fff;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, .18);
            overflow: hidden;
            transform: translateY(20px) scale(.97);
            transition: transform .35s cubic-bezier(.34, 1.3, .64, 1)
        }

        .m-ov.show .sm {
            transform: translateY(0) scale(1)
        }

        .sm-hdr {
            padding: 20px 22px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .sm-t {
            font-size: 15px;
            font-weight: 700;
            color: var(--dark)
        }

        .sm-s {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px
        }

        .sm-x {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1.5px solid var(--border);
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid);
            transition: .15s
        }

        .sm-x:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #ef4444
        }

        .sm-x svg {
            width: 14px;
            height: 14px
        }

        .sm-body {
            padding: 18px 22px
        }

        .sm-lbl {
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: .08em;
            text-transform: uppercase;
            margin: 24px 0 12px
        }

        .sm-pg {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px
        }

        .spc {
            border: 1.5px solid var(--border);
            border-radius: 12px;
            padding: 12px 8px 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: .18s
        }

        .spc:hover,
        .spc.sel {
            border-color: var(--blue);
            background: var(--blue-l);
            box-shadow: 0 0 0 3px rgba(59, 110, 248, .15)
        }

        .spd {
            font-size: 11px;
            font-weight: 600;
            color: var(--mid)
        }

        .spc.sel .spd {
            color: var(--blue)
        }

        .spun {
            font-size: 9px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sm-cats {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 4px;
        }

        .sm-cats::-webkit-scrollbar {
            display: none;
        }

        .sm-cat {
            padding: 7px 14px;
            border-radius: 20px;
            border: 1.5px solid var(--border);
            background: #fff;
            font-size: 11px;
            font-weight: 600;
            color: var(--mid);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .sm-cat:hover {
            border-color: var(--muted);
            color: var(--dark);
        }

        .sm-cat.active {
            background: var(--blue);
            color: #fff;
            border-color: var(--blue);
            box-shadow: 0 4px 12px rgba(59, 110, 248, 0.2);
        }

        .sm-cr {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 18px
        }

        .sm-ig {
            display: flex;
            flex-direction: column;
            gap: 5px
        }

        .sm-il {
            font-size: 11px;
            font-weight: 600;
            color: var(--mid)
        }

        .sm-in {
            width: 100%;
            padding: 9px 12px;
            border: 1.5px solid var(--border);
            border-radius: 9px;
            font-size: 13px;
            font-family: inherit;
            color: var(--dark);
            outline: none;
            transition: .15s
        }

        .sm-in:focus {
            border-color: var(--blue)
        }

        .sm-ut {
            display: flex;
            gap: 4px;
            background: var(--bg);
            border-radius: 9px;
            padding: 3px;
            margin-bottom: 18px;
            width: fit-content
        }

        .sm-ub {
            padding: 5px 14px;
            border-radius: 7px;
            border: none;
            background: none;
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            font-family: inherit;
            transition: .15s
        }

        .sm-ub.active {
            background: #fff;
            color: var(--blue);
            box-shadow: 0 1px 4px rgba(0, 0, 0, .08)
        }

        .sm-ftr {
            padding: 14px 22px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end
        }

        .sm-cancel {
            padding: 9px 20px;
            border: 1.5px solid var(--border);
            border-radius: 9px;
            background: none;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            color: var(--mid);
            cursor: pointer
        }

        .sm-apply {
            padding: 9px 24px;
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 9px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: .15s
        }

        .sm-apply:hover {
            background: #2b5ce6
        }

        .sm-apply svg {
            width: 14px;
            height: 14px
        }

        #tmov {
            position: fixed;
            inset: 0;
            background: rgba(8, 10, 25, .65);
            backdrop-filter: blur(12px);
            z-index: 9500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s, visibility .3s;
            padding: 16px
        }

        #tmov.show {
            opacity: 1;
            visibility: visible
        }

        .tm {
            background: #fff;
            border-radius: 24px;
            width: 100%;
            max-width: 1000px;
            height: min(92vh, 740px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 48px 120px rgba(0, 0, 0, .3);
            transform: scale(.92) translateY(36px);
            transition: transform .4s cubic-bezier(.34, 1.1, .64, 1)
        }

        #tmov.show .tm {
            transform: scale(1) translateY(0)
        }

        .tm-hdr {
            padding: 0 26px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            background: #fff
        }

        .tm-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 0 16px
        }

        .tm-ttl {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px
        }

        .tm-ico {
            width: 38px;
            height: 38px;
            border-radius: 11px;
            background: var(--blue-l);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue)
        }

        .tm-ico svg {
            width: 19px;
            height: 19px
        }

        .tm-x {
            width: 36px;
            height: 36px;
            border-radius: 11px;
            border: 1.5px solid var(--border);
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid);
            transition: .15s
        }

        .tm-x:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #ef4444
        }

        .tm-x svg {
            width: 14px;
            height: 14px
        }

        .tm-sf {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap
        }

        .tm-srch {
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            padding: 0 14px;
            gap: 9px;
            background: #fafbfe;
            transition: .15s
        }

        .tm-srch:focus-within {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(59, 110, 248, .1);
            background: #fff
        }

        .tm-srch svg {
            width: 15px;
            height: 15px;
            color: var(--muted);
            flex-shrink: 0
        }

        .srch-i {
            border: none;
            outline: none;
            background: none;
            font-size: 13px;
            font-family: inherit;
            color: var(--dark);
            flex: 1;
            padding: 11px 0
        }

        .srch-i::placeholder {
            color: var(--muted)
        }

        .srch-clr {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--muted);
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: #fff;
            flex-shrink: 0
        }

        .srch-clr.on {
            display: flex
        }

        .srch-clr svg {
            width: 9px;
            height: 9px
        }

        .fil-pills {
            display: flex;
            gap: 5px;
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            flex-shrink: 0
        }

        .fil-pills::-webkit-scrollbar {
            display: none
        }

        .fp {
            padding: 7px 14px;
            border-radius: 20px;
            border: 1.5px solid var(--border);
            background: #fff;
            font-size: 11px;
            font-weight: 600;
            color: var(--mid);
            cursor: pointer;
            white-space: nowrap;
            transition: .15s;
            font-family: inherit;
            flex-shrink: 0
        }

        .fp:hover {
            border-color: var(--blue);
            color: var(--blue)
        }

        .fp.on {
            background: var(--blue);
            border-color: var(--blue);
            color: #fff
        }

        .cat-row {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            margin: 0 -26px;
            padding: 0 26px;
            border-top: 1px solid var(--border)
        }

        .cat-row::-webkit-scrollbar {
            display: none
        }

        .ct {
            padding: 11px 18px;
            font-size: 13px;
            font-weight: 600;
            color: var(--mid);
            cursor: pointer;
            border-bottom: 2.5px solid transparent;
            white-space: nowrap;
            transition: .15s;
            flex-shrink: 0;
            user-select: none
        }

        .ct:hover {
            color: var(--dark)
        }

        .ct.on {
            color: var(--blue);
            border-bottom-color: var(--blue)
        }

        .tm-body {
            flex: 1;
            overflow-y: auto;
            padding: 22px 26px
        }

        .grid-hdr {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px
        }

        .grid-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: .07em;
            text-transform: uppercase
        }

        .grid-count {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500
        }

        .ph-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(175px, 1fr));
            gap: 13px
        }

        .ph-item {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            aspect-ratio: 4/3;
            border: 2.5px solid transparent;
            background: #dde1ee;
            transition: transform .2s, border-color .2s, box-shadow .2s
        }

        .ph-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .16)
        }

        .ph-item.on {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(59, 110, 248, .22)
        }

        .ph-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform .35s
        }

        .ph-item:hover img {
            transform: scale(1.06)
        }

        .ph-sel-ov {
            position: absolute;
            inset: 0;
            background: rgba(59, 110, 248, .1);
            opacity: 0;
            transition: .18s
        }

        .ph-item.on .ph-sel-ov {
            opacity: 1
        }

        .ph-chk {
            position: absolute;
            top: 9px;
            right: 9px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--blue);
            border: 2.5px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(.45) rotate(-20deg);
            transition: opacity .22s, transform .22s;
            box-shadow: 0 4px 14px rgba(59, 110, 248, .55)
        }

        .ph-item.on .ph-chk {
            opacity: 1;
            transform: scale(1) rotate(0)
        }

        .ph-chk svg {
            width: 13px;
            height: 13px;
            color: #fff
        }

        .ph-lbl {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 11px 9px;
            background: linear-gradient(transparent, rgba(0, 0, 0, .58));
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, .93);
            opacity: 0;
            transition: .18s
        }

        .ph-item:hover .ph-lbl {
            opacity: 1
        }

        .no-res {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            padding: 56px 20px;
            text-align: center
        }

        .no-res.on {
            display: flex
        }

        .nri {
            width: 74px;
            height: 74px;
            border-radius: 20px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center
        }

        .nri svg {
            width: 32px;
            height: 32px;
            color: var(--muted)
        }

        .no-res h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--mid)
        }

        .no-res p {
            font-size: 13px;
            color: var(--muted);
            max-width: 260px;
            line-height: 1.6
        }

        .nr-clr {
            padding: 9px 22px;
            background: var(--blue-l);
            color: var(--blue);
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            margin-top: 2px;
            transition: .15s
        }

        .nr-clr:hover {
            background: #d4e0fe
        }

        .tm-ftr {
            padding: 15px 26px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            background: #fafbfd
        }

        .sel-info {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .sel-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            transition: .2s;
            white-space: nowrap
        }

        .sel-badge.empty {
            background: var(--bg);
            color: var(--muted)
        }

        .sel-badge.has {
            background: var(--blue-l);
            color: var(--blue)
        }

        .sel-badge svg {
            width: 13px;
            height: 13px
        }

        .sel-txt {
            font-size: 13px;
            color: var(--mid);
            font-weight: 500
        }

        .ftr-btns {
            display: flex;
            gap: 10px
        }

        .f-cncl {
            padding: 9px 20px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            background: none;
            font-size: 13px;
            font-weight: 600;
            font-family: inherit;
            color: var(--mid);
            cursor: pointer;
            transition: .15s
        }

        .f-cncl:hover {
            border-color: var(--mid);
            color: var(--dark)
        }

        .f-add {
            padding: 9px 22px;
            background: var(--blue);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: .15s
        }

        .f-add:hover:not(:disabled) {
            background: #2b5ce6;
            transform: translateY(-1px)
        }

        .f-add:disabled {
            opacity: .38;
            cursor: not-allowed
        }

        .f-add svg {
            width: 14px;
            height: 14px
        }

        .f-add .badge {
            background: rgba(255, 255, 255, .28);
            border-radius: 10px;
            padding: 1px 8px;
            font-size: 11px;
            font-weight: 700;
            display: none
        }

        .f-add .badge.on {
            display: inline-block
        }

        #loader {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity .45s, visibility .45s
        }

        #loader.gone {
            opacity: 0;
            visibility: hidden;
            pointer-events: none
        }

        .ld-logo {
            width: 52px;
            height: 52px;
            background: var(--blue);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: ldPop .6s cubic-bezier(.34, 1.56, .64, 1) both
        }

        .ld-logo svg {
            width: 26px;
            height: 26px;
            fill: #fff
        }

        .ld-ttl {
            font-size: 15px;
            font-weight: 700;
            color: var(--dark);
            animation: ldUp .5s .15s both
        }

        .ld-sub {
            font-size: 12px;
            color: var(--muted);
            animation: ldUp .5s .25s both;
            margin-top: -10px
        }

        .ld-bw {
            width: 180px;
            height: 4px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            animation: ldUp .5s .3s both
        }

        .ld-bf {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--blue), #818cf8);
            border-radius: 4px;
            animation: ldProg 1.8s .35s cubic-bezier(.4, 0, .2, 1) forwards
        }

        .ld-dots {
            display: flex;
            gap: 6px;
            animation: ldUp .5s .2s both
        }

        .ld-dots span {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--blue);
            opacity: .25;
            animation: ldDot 1.2s infinite ease-in-out
        }

        .ld-dots span:nth-child(2) {
            animation-delay: .15s
        }

        .ld-dots span:nth-child(3) {
            animation-delay: .3s
        }

        @keyframes ldPop {
            from {
                transform: scale(.5);
                opacity: 0
            }

            to {
                transform: scale(1);
                opacity: 1
            }
        }

        @keyframes ldUp {
            from {
                transform: translateY(10px);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        @keyframes ldProg {
            0% {
                width: 0
            }

            60% {
                width: 75%
            }

            85% {
                width: 92%
            }

            100% {
                width: 100%
            }
        }

        @keyframes ldDot {

            0%,
            80%,
            100% {
                opacity: .2;
                transform: scale(.8)
            }

            40% {
                opacity: 1;
                transform: scale(1.1)
            }
        }

        /* toast notifications - Premium Bottom Right */
        #toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--dark);
            color: #fff;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .2);
            transform: translateY(100px);
            opacity: 0;
            transition: all .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 9999;
            border-left: 4px solid var(--blue);
        }

        #toast.on {
            transform: translateY(0);
            opacity: 1
        }

        #toast.success {
            background: #10b981;
            border-left: none;
        }

        #toast.error {
            background: #ef4444;
            border-left: none;
        }

        #toast.info {
            background: var(--blue);
            border-left: none;
        }

        .pov {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .3);
            z-index: 200;
            opacity: 0;
            transition: opacity .25s
        }

        .pov.show {
            opacity: 1
        }

        ::-webkit-scrollbar {
            width: 4px
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px
        }

        @media(max-width:680px) {
            body {
                flex-direction: column;
                height: 100dvh
            }

            .sidebar {
                display: none
            }

            .main {
                flex: 1;
                flex-direction: column;
                min-height: 0
            }

            .topnav {
                padding: 0 14px;
                height: 48px
            }

            .bc a,
            .bc .sep {
                display: none
            }

            .nav-r .ib {
                display: none
            }

            .mob-bar {
                display: flex
            }

            .tog-btn {
                display: flex
            }

            .content {
                flex: 1;
                min-height: 0;
                flex-direction: column
            }

            .canvas {
                flex: 1;
                min-height: 0;
                overflow: auto;
                padding: 14px
            }

            .rpanel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 75dvh;
                width: 100% !important;
                border-left: none;
                border-top: 1px solid var(--border);
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -8px 32px rgba(0, 0, 0, .12);
                z-index: 250;
                transform: translateY(100%);
                transition: transform .35s cubic-bezier(.32, .72, 0, 1);
                overflow-y: auto
            }

            .rpanel.open {
                transform: translateY(0)
            }

            .rpanel::before {
                content: '';
                display: block;
                width: 36px;
                height: 4px;
                background: var(--border);
                border-radius: 2px;
                margin: 10px auto 4px
            }

            .pov {
                display: block;
                pointer-events: none
            }

            .pov.show {
                pointer-events: all
            }

            .tm {
                max-width: 100%;
                height: 96dvh;
                border-radius: 20px
            }

            .ph-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr))
            }

            .tm-hdr {
                padding: 0 16px
            }

            .tm-body {
                padding: 16px
            }

            .tm-sf {
                flex-wrap: wrap
            }

            .tm-ftr {
                padding: 12px 16px
            }

            .cat-row {
                margin: 0 -16px;
                padding: 0 16px
            }
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="ld-logo"><svg viewBox="0 0 24 24">
                <path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L20 8.5v7L12 20 4 15.5v-7L12 4.18z" />
            </svg></div>
        <div class="ld-ttl">Theme Customizer</div>
        <div class="ld-sub">Setting up your workspace…</div>
        <div class="ld-dots"><span></span><span></span><span></span></div>
        <div class="ld-bw">
            <div class="ld-bf"></div>
        </div>
    </div>

    <!-- SIZE MODAL -->
    <div class="m-ov" id="sizeOv">
        <div class="sm">
            <div class="sm-hdr">
                <div>
                    <div class="sm-t">Edit Layer Size</div>
                    <div class="sm-s" id="szCurrentInfo">Current: 1920×1080</div>
                </div>
                <button class="sm-x" id="szX"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg></button>
            </div>
            <div class="sm-body">
                <div class="sm-lbl">Categories</div>
                <div class="sm-cats" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="sm-cat active" data-cat="popular">Popular</button>
                    <button class="sm-cat" data-cat="frame">Frame</button>
                    <button class="sm-cat" data-cat="flex">Flex</button>
                    <button class="sm-cat" data-cat="invitation">Invitation</button>
                    <button class="sm-cat" data-cat="album">Album</button>
                </div>

                <div class="sm-lbl">Preset Sizes</div>
                <div class="sm-pg" id="szPresets">
                    <!-- Popular -->
                    <div class="spc sel" data-w="1920" data-h="1080" data-cat="popular">
                        <div class="spd">1920×1080</div>
                        <div class="spun">Full HD</div>
                    </div>
                    <div class="spc" data-w="1080" data-h="1080" data-cat="popular">
                        <div class="spd">1080×1080</div>
                        <div class="spun">Square</div>
                    </div>
                    <div class="spc" data-w="1080" data-h="1350" data-cat="popular">
                        <div class="spd">1080×1350</div>
                        <div class="spun">Portrait</div>
                    </div>

                    <!-- Frame -->
                    <div class="spc" data-w="800" data-h="1000" data-cat="frame" style="display:none">
                        <div class="spd">8×10 in</div>
                        <div class="spun">800×1000</div>
                    </div>
                    <div class="spc" data-w="1200" data-h="1800" data-cat="frame" style="display:none">
                        <div class="spd">12×18 in</div>
                        <div class="spun">1200×1800</div>
                    </div>
                    <div class="spc" data-w="2400" data-h="3600" data-cat="frame" style="display:none">
                        <div class="spd">24×36 in</div>
                        <div class="spun">2400×3600</div>
                    </div>

                    <!-- Flex -->
                    <div class="spc" data-w="2000" data-h="1000" data-cat="flex" style="display:none">
                        <div class="spd">10×5 ft</div>
                        <div class="spun">2000×1000</div>
                    </div>
                    <div class="spc" data-w="3000" data-h="2000" data-cat="flex" style="display:none">
                        <div class="spd">6×4 ft</div>
                        <div class="spun">3000×2000</div>
                    </div>
                    <div class="spc" data-w="4000" data-h="3000" data-cat="flex" style="display:none">
                        <div class="spd">8×6 ft</div>
                        <div class="spun">4000×3000</div>
                    </div>

                    <!-- Invitation -->
                    <div class="spc" data-w="500" data-h="700" data-cat="invitation" style="display:none">
                        <div class="spd">5×7 in</div>
                        <div class="spun">500×700</div>
                    </div>
                    <div class="spc" data-w="600" data-h="400" data-cat="invitation" style="display:none">
                        <div class="spd">6×4 in</div>
                        <div class="spun">600×400</div>
                    </div>
                    <div class="spc" data-w="600" data-h="600" data-cat="invitation" style="display:none">
                        <div class="spd">Square</div>
                        <div class="spun">600×600</div>
                    </div>

                    <!-- Album -->
                    <div class="spc" data-w="1200" data-h="1200" data-cat="album" style="display:none">
                        <div class="spd">12×12 in</div>
                        <div class="spun">1200×1200</div>
                    </div>
                    <div class="spc" data-w="1200" data-h="1800" data-cat="album" style="display:none">
                        <div class="spd">12×18 in</div>
                        <div class="spun">1200×1800</div>
                    </div>
                    <div class="spc" data-w="1200" data-h="3600" data-cat="album" style="display:none">
                        <div class="spd">12×36 in</div>
                        <div class="spun">1200×3600</div>
                    </div>
                </div>
                <div class="sm-lbl">Custom Size</div>
                <div class="sm-ut" id="szUnits">
                    <button class="sm-ub active" data-unit="px">px</button>
                    <button class="sm-ub" data-unit="%">%</button>
                    <button class="sm-ub" data-unit="em">em</button>
                </div>
                <div class="sm-cr">
                    <div class="sm-ig"><label class="sm-il">Width</label><input type="number" class="sm-in" id="szW"
                            value="1920" min="1"></div>
                    <div class="sm-ig"><label class="sm-il">Height</label><input type="number" class="sm-in" id="szH"
                            value="1080" min="1"></div>
                </div>
            </div>
            <div class="sm-ftr">
                <button class="sm-cancel" id="szCancel">Cancel</button>
                <button class="sm-apply" id="szApply"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>Apply Size</button>
            </div>
        </div>
    </div>

    <!-- TEMPLATE MODAL -->
    <div id="tmov">
        <div class="tm">
            <div class="tm-hdr">
                <div class="tm-top">
                    <div class="tm-ttl">
                        <div class="tm-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="8" height="5" rx="1.2" />
                                <rect x="13" y="3" width="8" height="5" rx="1.2" />
                                <rect x="3" y="11" width="8" height="10" rx="1.2" />
                                <rect x="13" y="11" width="8" height="10" rx="1.2" />
                            </svg></div>Template Gallery
                    </div>
                    <button class="tm-x" id="tmX"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg></button>
                </div>
                <div class="tm-sf">
                    <div class="tm-srch">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                        <input type="text" class="srch-i" id="srchInput" placeholder="Search templates…">
                        <button class="srch-clr" id="srchClr"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <line x1="18" y1="6" x2="6" y2="18" />
                                <line x1="6" y1="6" x2="18" y2="18" />
                            </svg></button>
                    </div>
                    <div class="fil-pills" id="filters">
                        <button class="fp on" data-f="all">All</button>
                        <button class="fp" data-f="popular">⭐ Popular</button>
                        <button class="fp" data-f="new">✨ New</button>
                        <button class="fp" data-f="minimal">◻ Minimal</button>
                        <button class="fp" data-f="dark">🌑 Dark</button>
                        <button class="fp" data-f="colorful">🎨 Colorful</button>
                    </div>
                </div>
                <div class="cat-row" id="catRow"></div>
            </div>
            <div class="tm-body">
                <div class="grid-hdr">
                    <div class="grid-title" id="gridTitle">All Templates</div>
                    <div class="grid-count" id="gridCount"></div>
                </div>
                <div class="ph-grid" id="phGrid"></div>
                <div class="no-res" id="noRes">
                    <div class="nri"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                            <line x1="8" y1="11" x2="14" y2="11" />
                        </svg></div>
                    <h3>No images found</h3>
                    <p id="noResMsg">Try a different search term or category.</p>
                    <button class="nr-clr" id="noResClr">Clear filters</button>
                </div>
            </div>
            <div class="tm-ftr">
                <div class="sel-info">
                    <div class="sel-badge empty" id="selBadge"><svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5">
                            <polyline points="20 6 9 17 4 12" />
                        </svg><span id="selNum">0</span></div>
                    <span class="sel-txt" id="selTxt">No images selected</span>
                </div>
                <div class="ftr-btns">
                    <button class="f-cncl" id="tmCancel">Cancel</button>
                    <button class="f-add" id="tmAdd" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                        Add to Canvas <span class="badge" id="addBadge">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="sb-logo"><svg viewBox="0 0 24 24">
                <path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L20 8.5v7L12 20 4 15.5v-7L12 4.18z" />
            </svg></div>
        <div class="sb-icon active" id="sbSize" title="Layer Size"><svg viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <path d="M3 9h18M9 3v18" />
                <path d="M14 14l3 3m0 0l-3 0m3 0V14" />
            </svg></div>
        <div class="sb-icon" id="sbTmpl" title="Templates"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <rect x="3" y="3" width="8" height="5" rx="1.2" />
                <rect x="13" y="3" width="8" height="5" rx="1.2" />
                <rect x="3" y="11" width="8" height="10" rx="1.2" />
                <rect x="13" y="11" width="8" height="10" rx="1.2" />
            </svg></div>
        <div class="sb-icon" id="sbUpload" title="Upload Image">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
        </div>
        <!-- <div class="sb-icon" id="sbText" title="Add Text">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="4 7 4 4 20 4 20 7" />
                <line x1="9" y1="20" x2="15" y2="20" />
                <line x1="12" y1="4" x2="12" y2="20" />
            </svg>
        </div> -->
        <div class="sb-icon" id="sbDocMode" title="Doc Mode Editor">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <polyline points="10 9 9 9 8 9" />
            </svg>
        </div>
        <input type="file" id="fileInp" accept="image/*" style="display:none">
        <div class="sb-icon" title="Messages"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            </svg></div>
        <div class="sb-icon" title="Bookmark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
            </svg></div>
        <div class="sb-icon" title="Settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="12" cy="12" r="3" />
                <path
                    d="M19.07 4.93l-1.41 1.41M4.93 19.07l-1.41 1.41M19.07 19.07l-1.41-1.41M4.93 4.93l1.41 1.41M21 12h-2M5 12H3M12 21v-2M12 5V3" />
            </svg></div>
        <div class="sb-div"></div>
        <div class="sb-icon" id="btnExport" title="Export Project (JSON)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
        </div>
        <div class="sb-icon" id="btnImport" title="Import Project (JSON)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
        </div>
        <input type="file" id="importInp" accept="application/json" style="display:none">

        <div class="sb-icon" id="sbDlBtn" title="Export Image (PNG)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
        </div>
        <div class="sb-btm">
            <div class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3M12 17h.01" />
                </svg></div>
            <div class="sb-av">O</div>
        </div>
    </nav>

    <div class="main">
        <header class="topnav">
            <div class="bc">
                <svg style="width:15px;height:15px" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
                <span class="sep">›</span><a href="#">Customization</a><span class="sep">›</span><a
                    href="#">Themes</a><span class="sep">›</span><span class="cur">Create</span>
            </div>
            <div class="nav-r">
                <div class="ib"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" />
                        <path d="M8 21h8M12 17v4" />
                    </svg></div>
                <div class="ib"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3" />
                        <circle cx="6" cy="12" r="3" />
                        <circle cx="18" cy="19" r="3" />
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
                    </svg></div>
                <button class="tog-btn" id="panelTog"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.07 4.93l-1.41 1.41M4.93 19.07l-1.41 1.41M19.07 19.07l-1.41-1.41M4.93 4.93l1.41 1.41M21 12h-2M5 12H3M12 21v-2M12 5V3" />
                    </svg></button>
                <div class="mi-sep" style="height: 24px;"></div>
                <div class="ib disabled" id="btnUndo" title="Undo (Ctrl+Z)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6" />
                        <path d="M21 17a9 9 0 0 0-9-15 9 9 0 0 0-6 2.3L3 13" />
                    </svg>
                </div>
                <div class="ib disabled" id="btnRedo" title="Redo (Ctrl+Y)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6" />
                        <path d="M3 17a9 9 0 0 1 9-15 9 9 0 0 1 6 2.3L21 13" />
                    </svg>
                </div>
                <div class="ib danger disabled" id="btnDeleteTop" title="Delete (Del)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6" />
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                    </svg>
                </div>
                <div class="mi-sep" style="height: 24px;"></div>
                <button class="pub" id="dlBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        style="width:14px;height:14px;vertical-align:middle;margin-right:5px">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>Download
                </button>
                <div class="mi-sep" style="height: 24px;"></div>
                <button class="pub" id="btnAppExit" style="background:#ff4b2b;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        style="width:14px;height:14px;vertical-align:middle;margin-right:2px">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                </button>
            </div>
        </header>
        <div class="mob-bar">
            <div class="mob-inner">
                <div class="mi active" id="mSbSize"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" />
                        <path d="M3 9h18M9 3v18" />
                    </svg><span>Sizes</span></div>
                <div class="mi" id="mSbTmpl"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="3" width="8" height="5" rx="1.2" />
                        <rect x="13" y="3" width="8" height="5" rx="1.2" />
                        <rect x="3" y="11" width="8" height="10" rx="1.2" />
                        <rect x="13" y="11" width="8" height="10" rx="1.2" />
                    </svg><span>Templates</span></div>
                <div class="mi" id="mSbText"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <polyline points="4 7 4 4 20 4 20 7" />
                        <line x1="9" y1="20" x2="15" y2="20" />
                        <line x1="12" y1="4" x2="12" y2="20" />
                    </svg><span>Text</span></div>
                <div class="mi" id="mSbUpload"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg><span>Upload</span></div>
                <div class="mi" id="mSbDocMode"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg><span>Doc Mode</span></div>
                <div class="mi" id="mSbExport"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" <path
                        d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                    </svg><span>Save</span>
                </div>
                <div class="mi" id="mSbDownload"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg><span>PNG</span></div>
                <div class="mi-sep"></div>
                <div class="mi-av">O</div>
            </div>
        </div>

        <div class="content">
            <div class="canvas" id="canvas">
                <div class="canvas-empty" id="canvasEmpty">
                    <div class="ce-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                            <circle cx="9" cy="9" r="2" />
                            <path d="M21 15l-5-5L5 21" />
                        </svg>
                    </div>
                    <h3>Welcome to the Editor</h3>
                    <p>Select a size or <strong>Upload an image</strong> to start designing your masterpiece</p>
                </div>

                <!-- Zoom Controls -->
                <div class="zoom-ctrl">
                    <button class="zc-btn" id="zoomOut" title="Zoom Out">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                    </button>
                    <div class="zc-val" id="zoomVal">100%</div>
                    <button class="zc-btn" id="zoomIn" title="Zoom In">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                    </button>
                    <div class="zc-sep"></div>
                    <button class="zc-btn" id="zoomFit" title="Fit to Screen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
                        </svg>
                    </button>
                    <div class="zc-sep"></div>
                    <button class="zc-btn" id="canvasRotate" title="Swap Orientation">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L1 10" />
                        </svg>
                    </button>
                </div>

                <div class="layer-wrap" id="layerWrap">
                    <div class="c-layer" id="cLayer">
                        <div class="layer-img-grid" id="layerImgGrid"></div>
                        <div class="layer-handle-ov" id="layerHandleOv"></div>
                        <div class="layer-placeholder" id="layerPlaceholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                            <p>No elements on canvas. Add a template or upload an image to begin.</p>
                        </div>
                        <div class="l-sel"></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL -->
            <aside class="rpanel" id="rpanel">
                <div class="rp-tabs">
                    <div class="rp-tab" data-tab="Pages">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <path d="M7 7h10M7 12h10M7 17h10" />
                        </svg>Pages
                    </div>
                    <div class="rp-tab" data-tab="Layers">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" />
                            <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2" />
                        </svg>Layers
                    </div>
                    <div class="rp-tab on" data-tab="Props">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 20h9" />
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                        </svg>Properties
                    </div>
                </div>

                <!-- PAGES VIEW -->
                <div class="rp-view" id="viewPages">
                    <div class="lv-hdr">
                        <div class="lv-title">Project Pages</div>
                        <div style="display:flex; gap:5px;">
                            <button class="lv-add" id="btnSlideshow" title="Play Slideshow"
                                style="background:var(--blue-l); color:var(--blue);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <polygon points="5 3 19 12 5 21 5 3" />
                                </svg>
                            </button>
                            <button class="lv-add" id="pgAdd" title="Create New Page">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <line x1="12" y1="5" x2="12" y2="19" />
                                    <line x1="5" y1="12" x2="19" y2="12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="lv-list" id="pgList"></div>
                </div>

                <!-- LAYERS VIEW -->
                <div class="rp-view" id="viewLayers">
                    <div class="lv-hdr">
                        <div class="lv-title">Image Layers</div>
                        <button class="lv-add" id="lvAdd" title="Add templates">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                        </button>
                    </div>
                    <div class="lv-list" id="lvList">
                        <div class="lv-empty" id="lvEmpty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                            <p>No image layers yet.<br>Click <strong>+</strong> to add templates.</p>
                        </div>
                    </div>
                </div>

                <!-- PROPERTIES VIEW -->
                <div class="rp-view on" id="viewProps">
                    <div class="no-sel-msg" id="noSelMsg">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M15 15l6 6m-11-4a7 7 0 1 1 0-14 7 7 0 0 1 0 14z" />
                        </svg>
                        <p>Select a layer from the <strong>Layers</strong> tab to edit its properties</p>
                    </div>
                    <div id="propsContent"
                        style="display:none;flex-direction:column;flex:1;overflow-y:auto; padding: 0 16px 20px;">

                        <!-- 1. Layer Identity / Preview -->
                        <div class="ps" id="secIdentity">
                            <div class="img-prev">
                                <img id="ppImg" src="" alt="">
                                <div class="img-prev-ov"><span class="img-prev-name" id="ppName"></span></div>
                            </div>
                        </div>

                        <!-- 2. Typography (Only for text) -->
                        <div id="secTypography" style="display:none">
                            <div class="ps">
                                <div class="ps-lbl" style="color:var(--blue);"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2.5">
                                        <path d="M4 7V4h16v3M9 20h6M12 4v16" />
                                    </svg>Typography</div>

                                <div class="sl-row" style="margin-bottom:12px">
                                    <div class="sl-hdr"><span class="sl-lbl">Font Family</span></div>
                                    <select class="sl" id="txtFont"
                                        style="width:100%; height:36px; border:1.5px solid var(--border); border-radius:8px; background:var(--bg); font-weight:600; outline:none; padding: 0 10px;">
                                        <option value="inherit">Default</option>
                                        <option value="'Inter', sans-serif">Inter</option>
                                        <option value="'Playfair Display', serif">Playfair</option>
                                        <option value="'Roboto Mono', monospace">Mono</option>
                                        <option value="'Outfit', sans-serif">Outfit</option>
                                    </select>
                                </div>

                                <div
                                    style="display:grid; grid-template-columns: 1fr 40px; gap:10px; align-items:end; margin-bottom:12px;">
                                    <div class="sl-row" style="margin:0">
                                        <div class="sl-hdr">
                                            <span class="sl-lbl">Size</span>
                                            <span class="sl-val" id="valTxtSize">24px</span>
                                        </div>
                                        <input type="range" class="sl" id="txtSize" min="8" max="200" value="24">
                                    </div>
                                    <input type="color" id="txtColor" value="#000000"
                                        style="width:40px; height:40px; border:1.5px solid var(--border); border-radius:8px; background:var(--bg); cursor:pointer; padding:2px;">
                                </div>

                                <div class="sl-row" style="margin-bottom:16px">
                                    <div class="palette" style="display:flex; gap:6px; flex-wrap:wrap;">
                                        <div class="pal-col" data-color="#000000"
                                            style="width:20px; height:20px; border-radius:4px; background:#000; cursor:pointer; border:1px solid #ddd;">
                                        </div>
                                        <div class="pal-col" data-color="#ffffff"
                                            style="width:20px; height:20px; border-radius:4px; background:#fff; cursor:pointer; border:1px solid #ddd;">
                                        </div>
                                        <div class="pal-col" data-color="#3b82f6"
                                            style="width:20px; height:20px; border-radius:4px; background:#3b82f6; cursor:pointer; border:1px solid #ddd;">
                                        </div>
                                        <div class="pal-col" data-color="#ef4444"
                                            style="width:20px; height:20px; border-radius:4px; background:#ef4444; cursor:pointer; border:1px solid #ddd;">
                                        </div>
                                        <div class="pal-col" data-color="#10b981"
                                            style="width:20px; height:20px; border-radius:4px; background:#10b981; cursor:pointer; border:1px solid #ddd;">
                                        </div>
                                        <div class="pal-col" data-color="#f59e0b"
                                            style="width:20px; height:20px; border-radius:4px; background:#f59e0b; cursor:pointer; border:1px solid #ddd;">
                                        </div>
                                    </div>
                                </div>

                                <div class="tc-grid"
                                    style="display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin-bottom:6px;">
                                    <button class="tc-btn" id="btnBold" title="Bold"><b>B</b></button>
                                    <button class="tc-btn" id="btnItalic" title="Italic"><i>I</i></button>
                                    <button class="tc-btn" id="btnUnderline" title="Underline"><u>U</u></button>
                                    <button class="tc-btn" id="btnStrike" title="Strikethrough"><s>S</s></button>
                                </div>

                                <div class="tc-grid"
                                    style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; margin-bottom:20px;">
                                    <button class="tc-btn" id="btnUpper" title="Uppercase">AA</button>
                                    <button class="tc-btn" id="btnLower" title="Lowercase">aa</button>
                                    <button class="tc-btn" id="btnCap" title="Capitalize">Aa</button>
                                </div>

                                <div class="ps-lbl"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                                    </svg>Effects / Alignment</div>
                                <div class="tc-grid"
                                    style="grid-template-columns: repeat(3, 1fr); gap:6px; margin-bottom:10px;">
                                    <button class="tc-btn" id="btnShadow" title="Shadow">Shadow</button>
                                    <button class="tc-btn" id="btnStroke" title="Stroke">Stroke</button>
                                    <button class="tc-btn" id="btnHighlight" title="Highlight">Highlt</button>
                                </div>

                                <div id="advTextControls"
                                    style="display:none; flex-direction:column; gap:8px; margin-bottom:12px;">
                                    <div class="sl-row" id="rowShadow" style="display:none; margin:0">
                                        <div class="sl-hdr"><span class="sl-lbl">Blur</span><input type="color"
                                                id="shadowColor"
                                                style="width:20px;height:20px;border:none;padding:0;background:none;cursor:pointer">
                                        </div>
                                        <input type="range" class="sl" id="shadowBlur" min="0" max="20">
                                    </div>
                                    <div class="sl-row" id="rowStroke" style="display:none; margin:0">
                                        <div class="sl-hdr"><span class="sl-lbl">Width</span><input type="color"
                                                id="strokeColor"
                                                style="width:20px;height:20px;border:none;padding:0;background:none;cursor:pointer">
                                        </div>
                                        <input type="range" class="sl" id="strokeWidth" min="0" max="10" step="0.5">
                                    </div>
                                    <div class="sl-row" id="rowHighlight" style="display:none; margin:0">
                                        <input type="color" id="highlightColor"
                                            style="width:100%;height:24px;border-radius:4px;border:1.5px solid var(--border);padding:2px;cursor:pointer">
                                    </div>
                                </div>

                                <div class="tc-grid" style="grid-template-columns: repeat(3, 1fr); gap:6px;">
                                    <button class="tc-btn" id="btnAlignL"><svg viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2.5" style="width:14px">
                                            <line x1="17" y1="10" x2="3" y2="10" />
                                            <line x1="21" y1="6" x2="3" y2="6" />
                                            <line x1="21" y1="14" x2="3" y2="14" />
                                            <line x1="17" y1="18" x2="3" y2="18" />
                                        </svg></button>
                                    <button class="tc-btn" id="btnAlignC"><svg viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2.5" style="width:14px">
                                            <line x1="18" y1="10" x2="6" y2="10" />
                                            <line x1="21" y1="6" x2="3" y2="6" />
                                            <line x1="21" y1="14" x2="3" y2="14" />
                                            <line x1="18" y1="18" x2="6" y2="18" />
                                        </svg></button>
                                    <button class="tc-btn" id="btnAlignR"><svg viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2.5" style="width:14px">
                                            <line x1="21" y1="10" x2="7" y2="10" />
                                            <line x1="21" y1="6" x2="3" y2="6" />
                                            <line x1="21" y1="14" x2="3" y2="14" />
                                            <line x1="21" y1="18" x2="7" y2="18" />
                                        </svg></button>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Image Only (Crop/Replace) -->
                        <div id="secImage" style="display:none">
                            <div class="ps">
                                <button class="pub" id="replBtn"
                                    style="width:100%; justify-content:center; margin-bottom:12px">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        style="width:14px; margin-right:6px">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="17 8 12 3 7 8" />
                                        <line x1="12" y1="3" x2="12" y2="15" />
                                    </svg> Replace Image
                                </button>
                                <div class="ps-lbl"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M6 2v14a2 2 0 0 0 2 2h14" />
                                        <path d="M18 22V8a2 2 0 0 0-2-2H2" />
                                    </svg>Crop Image</div>
                                <div style="display:flex; gap:8px;">
                                    <button class="tc-btn" id="cropOpenBtn" style="flex:1">Open Cropper</button>
                                    <button class="tc-btn" id="cropResetBtn" style="padding:0 10px"><svg
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            style="width:14px">
                                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                            <path d="M3 3v5h5" />
                                        </svg></button>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Editor Mode (Extra) -->
                        <div class="ps">
                            <div class="ps-lbl" style="color:var(--blue);"><svg viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2.5">
                                    <path d="M4 6h16M4 12h16M4 18h16" />
                                </svg>Editor Mode</div>
                            <button class="tc-btn" id="btnNotepad"
                                style="width:100%; justify-content:center; padding: 10px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                    style="width:14px;margin-right:8px">
                                    <path d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                                Lined Writing Guide
                            </button>
                        </div>

                        <!-- Transform -->
                        <div class="ps">
                            <div class="ps-lbl">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 3l14 9-14 9V3z" />
                                </svg>Transform
                            </div>
                            <div class="tc-grid">
                                <button class="tc-btn" id="btnRotL"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38" />
                                    </svg>Rotate L</button>
                                <button class="tc-btn" id="btnRotR"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38" />
                                    </svg>Rotate R</button>
                                <button class="tc-btn" id="btnFlipH"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3" />
                                        <path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3" />
                                        <line x1="12" y1="20" x2="12" y2="4" />
                                    </svg>Flip H</button>
                                <button class="tc-btn" id="btnFlipV"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M21 8V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v3" />
                                        <path d="M21 16v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3" />
                                        <line x1="4" y1="12" x2="20" y2="12" />
                                    </svg>Flip V</button>
                                <button class="tc-btn tc-full" id="btnResetT"><svg viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2">
                                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                        <path d="M3 3v5h5" />
                                    </svg>Reset Transform</button>
                            </div>
                        </div>

                        <!-- Rotation & Scale -->
                        <div class="ps">
                            <div class="ps-lbl">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9" />
                                </svg>Rotation &amp; Scale
                            </div>
                            <div class="sl-row">
                                <div class="sl-hdr">
                                    <span class="sl-lbl">Rotation</span>
                                    <span class="sl-val" id="valRotate">0°</span>
                                </div>
                                <div class="sl-ctrl">
                                    <input type="range" class="sl" id="slRotate" min="-180" max="180" value="0">
                                </div>
                            </div>
                            <div class="sl-row">
                                <div class="sl-hdr">
                                    <span class="sl-lbl">Scale</span>
                                    <span class="sl-val" id="valScale">100%</span>
                                </div>
                                <div class="sl-ctrl">
                                    <input type="range" class="sl" id="slScale" min="10" max="300" value="100">
                                </div>
                            </div>
                        </div>

                        <!-- Opacity -->
                        <div class="ps">
                            <div class="ps-lbl">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10" />
                                    <path d="M12 2a10 10 0 0 1 0 20V2z" />
                                </svg>Opacity
                            </div>
                            <div class="sl-row">
                                <div class="sl-hdr">
                                    <span class="sl-lbl">Layer Opacity</span>
                                    <span class="sl-val" id="valOpacity">100%</span>
                                </div>
                                <div class="sl-ctrl">
                                    <input type="range" class="sl" id="slOpacity" min="0" max="100" value="100">
                                </div>
                            </div>
                        </div>



                        <!-- Layout Actions -->
                        <div class="ps">
                            <div class="ps-lbl">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                    <line x1="9" y1="3" x2="9" y2="21" />
                                </svg>Layout Actions
                            </div>
                            <div style="display: grid; gap: 10px;">
                                <button class="tc-btn tc-full" id="btnFitScreen"
                                    style="padding: 12px; font-size: 11px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                        style="margin-right: 8px; width: 16px; height: 16px;">
                                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
                                    </svg>
                                    Fit to Screen Size
                                </button>
                            </div>
                        </div>



                        <!-- Delete -->
                        <div class="del-zone">
                            <button class="del-btn-full" id="delLayerBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6" />
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
                                </svg>
                                Delete This Layer
                            </button>
                        </div>

                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- SLIDESHOW OVERLAY -->
    <div id="slideOv"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:10000; flex-direction:column; align-items:center; justify-content:center; color:#fff; overflow:hidden;">
        <div style="position:absolute; top:20px; right:20px; display:flex; gap:15px; align-items:center;">
            <div id="slideCounter" style="font-size:14px; font-weight:600; opacity:0.8;">Page 1 / 1</div>
            <button id="slideExit" style="background:none; border:none; color:#fff; cursor:pointer;"><svg
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    style="width:24px;height:24px;">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg></button>
        </div>
        <div id="slideContent"
            style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; transition: transform 0.3s ease;">
        </div>
        <div
            style="position:absolute; bottom:40px; display:flex; gap:20px; align-items:center; background:rgba(255,255,255,0.1); padding:10px 25px; border-radius:50px; backdrop-filter:blur(10px);">
            <button id="slidePrev" style="background:none; border:none; color:#fff; cursor:pointer;"><svg
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    style="width:20px;height:20px;">
                    <polyline points="15 18 9 12 15 6" />
                </svg></button>
            <button id="slideAuto"
                style="background:var(--blue); border:none; color:#fff; padding:5px 15px; border-radius:20px; font-size:12px; font-weight:700; cursor:pointer;">AutoPlay</button>
            <button id="slideNext" style="background:none; border:none; color:#fff; cursor:pointer;"><svg
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    style="width:20px;height:20px;">
                    <polyline points="9 18 15 12 9 6" />
                </svg></button>
        </div>
    </div>

    <!-- DOC MODE MODAL -->
    <div id="docModeOv">
        <div class="doc-modal">
            <div class="doc-m-hdr"
                style="padding:16px; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
                <div class="doc-m-ttl"
                    style="display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 15px; color: var(--dark);">
                    <div class="doc-m-ico"
                        style="width: 36px; height: 36px; background: var(--blue-l); color: var(--blue); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                            style="width: 18px; height: 18px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                        </svg>
                    </div>
                    Doc Editor
                </div>

                <div class="doc-m-ctrls" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <!-- Font Family -->
                    <select id="docFontFamily"
                        style="padding: 6px 10px; border-radius: 10px; border: 1.5px solid #e2e8f0; background: #f8fafc; font-size: 13px; font-weight: 600; color: var(--dark); outline: none; cursor: pointer; min-width: 110px;">
                        <option value="inherit">Default</option>
                        <option value="'Inter', sans-serif">Inter</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Courier New', monospace">Courier</option>
                        <option value="'Times New Roman', serif">Times</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="'Comic Sans MS', cursive">Comic Sans</option>
                        <option value="Impact, sans-serif">Impact</option>
                    </select>

                    <!-- Font Size -->
                    <div
                        style="display: flex; align-items: center; gap: 4px; background: #f8fafc; padding: 4px 6px 4px 10px; border-radius: 10px; border: 1.5px solid #e2e8f0;">
                        <span
                            style="font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: .08em;">Size</span>
                        <input type="number" id="docFontSize" min="1" max="500" value="16"
                            style="width: 45px; border: none; background: transparent; font-size: 13px; font-weight: 700; color: var(--blue); outline: none; padding: 4px 0;">
                        <span style="font-size: 11px; font-weight: 600; color: var(--muted);">px</span>
                    </div>

                    <!-- Text Color -->
                    <div
                        style="display: flex; align-items: center; gap: 6px; background: #f8fafc; padding: 4px 10px; border-radius: 10px; border: 1.5px solid #e2e8f0;">
                        <span
                            style="font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: .08em;">Color</span>
                        <input type="color" id="docColor" value="#2e3e4e"
                            style="width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer; padding: 0;">
                    </div>

                    <button class="doc-m-x" id="docModeX"
                        style="width: 36px; height: 36px; border-radius: 50%; border: none; background: none; cursor: pointer; color: var(--muted); display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                            style="width: 20px; height: 20px;">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>


            </div>

            <!-- Typography Toolbar Row -->
            <div
                style="padding: 10px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; flex-wrap: wrap; background: #fafbfe;">
                <!-- Bold / Italic / Underline / Strikethrough -->
                <div style="display: flex; gap: 3px; background: #f1f3f9; padding: 3px; border-radius: 10px;">
                    <button class="doc-tool-btn" id="docBold" title="Bold"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 15px; transition: all 0.2s;">B</button>
                    <button class="doc-tool-btn" id="docItalic" title="Italic"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; font-style: italic; font-weight: 700; font-size: 15px; transition: all 0.2s;">I</button>
                    <button class="doc-tool-btn" id="docUnderline" title="Underline"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; text-decoration: underline; font-weight: 700; font-size: 15px; transition: all 0.2s;">U</button>
                    <button class="doc-tool-btn" id="docStrike" title="Strikethrough"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; text-decoration: line-through; font-weight: 700; font-size: 15px; transition: all 0.2s;">S</button>
                </div>

                <div style="width: 1px; height: 24px; background: var(--border);"></div>

                <!-- Text Case -->
                <div style="display: flex; gap: 3px; background: #f1f3f9; padding: 3px; border-radius: 10px;">
                    <button class="doc-tool-btn" id="docUpper" title="UPPERCASE"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 10px; transition: all 0.2s;">AA</button>
                    <button class="doc-tool-btn" id="docLower" title="lowercase"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 10px; transition: all 0.2s;">aa</button>
                    <button class="doc-tool-btn" id="docCap" title="Capitalize"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 10px; transition: all 0.2s;">Aa</button>
                </div>

                <div style="width: 1px; height: 24px; background: var(--border);"></div>

                <!-- Alignment -->
                <div class="doc-tool-grp"
                    style="display: flex; gap: 3px; background: #f1f3f9; padding: 3px; border-radius: 10px;">
                    <button class="doc-tool-btn" id="docAlignL" title="Left"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                            style="width: 16px; height: 16px;">
                            <line x1="17" y1="10" x2="3" y2="10" />
                            <line x1="21" y1="6" x2="3" y2="6" />
                            <line x1="21" y1="14" x2="3" y2="14" />
                            <line x1="17" y1="18" x2="3" y2="18" />
                        </svg>
                    </button>
                    <button class="doc-tool-btn" id="docAlignC" title="Center"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                            style="width: 16px; height: 16px;">
                            <line x1="18" y1="10" x2="6" y2="10" />
                            <line x1="21" y1="6" x2="3" y2="6" />
                            <line x1="21" y1="14" x2="3" y2="14" />
                            <line x1="18" y1="18" x2="6" y2="18" />
                        </svg>
                    </button>
                    <button class="doc-tool-btn" id="docAlignR" title="Right"
                        style="width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; color: var(--mid); display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                            style="width: 16px; height: 16px;">
                            <line x1="21" y1="10" x2="7" y2="10" />
                            <line x1="21" y1="6" x2="3" y2="6" />
                            <line x1="21" y1="14" x2="3" y2="14" />
                            <line x1="21" y1="18" x2="7" y2="18" />
                        </svg>
                    </button>
                </div>

                <div style="width: 1px; height: 24px; background: var(--border);"></div>

                <!-- Line Height -->
                <div
                    style="display: flex; align-items: center; gap: 4px; background: #f1f3f9; padding: 4px 10px; border-radius: 10px;">
                    <span style="font-size: 10px; font-weight: 800; color: #64748b; letter-spacing: .05em;">LH</span>
                    <input type="number" id="docLineHeight" min="0.5" max="5" step="0.1" value="1.6"
                        style="width: 40px; border: none; background: transparent; font-size: 12px; font-weight: 700; color: var(--dark); outline: none;">
                </div>

                <!-- Letter Spacing -->
                <div
                    style="display: flex; align-items: center; gap: 4px; background: #f1f3f9; padding: 4px 10px; border-radius: 10px;">
                    <span style="font-size: 10px; font-weight: 800; color: #64748b; letter-spacing: .05em;">LS</span>
                    <input type="number" id="docLetterSpacing" min="-5" max="30" step="0.5" value="0"
                        style="width: 40px; border: none; background: transparent; font-size: 12px; font-weight: 700; color: var(--dark); outline: none;">
                    <span style="font-size: 10px; color: var(--muted);">px</span>
                </div>
            </div>

            <!-- Split Color Row -->
            <div id="docGradRow"
                style="padding: 10px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; background: #f8f9fe;">
                <!-- Toggle -->
                <button id="docGradToggle" title="Toggle Split Color"
                    style="padding: 5px 12px; border-radius: 8px; border: 1.5px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 11px; font-weight: 700; color: var(--mid); display: flex; align-items: center; gap: 5px; transition: all 0.2s;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 14px; height: 14px;">
                        <rect x="3" y="3" width="18" height="18" rx="3" />
                        <line x1="3" y1="12" x2="21" y2="12" />
                    </svg>
                    Split Color
                </button>

                <div style="width: 1px; height: 24px; background: var(--border);"></div>

                <!-- Split Count -->
                <div style="display: flex; gap: 3px; background: #f1f3f9; padding: 3px; border-radius: 10px;">
                    <button class="doc-grad-cnt" id="docSplit2" data-cnt="2" title="2 Colors"
                        style="padding: 4px 10px; border-radius: 7px; border: none; background: none; cursor: pointer; font-size: 11px; font-weight: 800; color: var(--mid); transition: all 0.2s;">2</button>
                    <button class="doc-grad-cnt" id="docSplit3" data-cnt="3" title="3 Colors"
                        style="padding: 4px 10px; border-radius: 7px; border: none; background: none; cursor: pointer; font-size: 11px; font-weight: 800; color: var(--mid); transition: all 0.2s;">3</button>
                </div>

                <div style="width: 1px; height: 24px; background: var(--border);"></div>

                <!-- Top Color -->
                <div
                    style="display: flex; align-items: center; gap: 4px; background: #f1f3f9; padding: 4px 8px; border-radius: 8px;">
                    <span style="font-size: 9px; font-weight: 800; color: #64748b; letter-spacing: .05em;">TOP</span>
                    <input type="color" id="docGradTop" value="#ffd700"
                        style="width: 24px; height: 24px; border: none; border-radius: 5px; cursor: pointer; padding: 0;">
                </div>

                <!-- Mid Color (only visible for 3-split) -->
                <div id="docGradMidWrap"
                    style="display: none; align-items: center; gap: 4px; background: #f1f3f9; padding: 4px 8px; border-radius: 8px;">
                    <span style="font-size: 9px; font-weight: 800; color: #64748b; letter-spacing: .05em;">MID</span>
                    <input type="color" id="docGradMid" value="#ff6b6b"
                        style="width: 24px; height: 24px; border: none; border-radius: 5px; cursor: pointer; padding: 0;">
                </div>

                <!-- Bottom Color -->
                <div
                    style="display: flex; align-items: center; gap: 4px; background: #f1f3f9; padding: 4px 8px; border-radius: 8px;">
                    <span style="font-size: 9px; font-weight: 800; color: #64748b; letter-spacing: .05em;">BTM</span>
                    <input type="color" id="docGradBtm" value="#228b22"
                        style="width: 24px; height: 24px; border: none; border-radius: 5px; cursor: pointer; padding: 0;">
                </div>

            </div>

            <!-- Outline & Shadow Effects Row -->
            <div id="docEffectsRow"
                style="padding: 10px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; background: #fff;">

                <!-- Stroke / Outline -->
                <div
                    style="display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 4px 10px; border-radius: 10px; border: 1.5px solid #e2e8f0;">
                    <span
                        style="font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase;">Outline</span>
                    <input type="number" id="docStrokeWidth" min="0" max="20" value="0"
                        style="width: 35px; border: none; background: transparent; font-size: 12px; font-weight: 700; color: var(--blue); outline: none;">
                    <input type="color" id="docStrokeColor" value="#ffffff"
                        style="width: 22px; height: 22px; border: none; border-radius: 4px; cursor: pointer; padding: 0;">
                </div>

                <div style="width: 1px; height: 24px; background: var(--border);"></div>

                <!-- Shadow -->
                <div
                    style="display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 4px 10px; border-radius: 10px; border: 1.5px solid #e2e8f0;">
                    <span
                        style="font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase;">Shadow</span>
                    <input type="number" id="docShadowBlur" min="0" max="50" value="0"
                        style="width: 35px; border: none; background: transparent; font-size: 12px; font-weight: 700; color: var(--blue); outline: none;">
                    <input type="color" id="docShadowColor" value="#000000"
                        style="width: 22px; height: 22px; border: none; border-radius: 4px; cursor: pointer; padding: 0;">
                </div>
            </div>


            <div class="doc-m-body">
                <div class="doc-sheet" id="docSheet" contenteditable="true" spellcheck="false"
                    placeholder="Start typing your document here..."></div>
            </div>
            <div class="doc-m-ftr">
                <button class="doc-btn doc-btn-cancel" id="docModeCancel">Cancel</button>
                <button class="doc-btn doc-btn-apply" id="docModeApply">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                    Apply to Canvas
                </button>
            </div>
        </div>
    </div>

    <div class="pov" id="pov"></div>
    <div id="toast"></div>

    <input type="file" id="mainUploadInp" accept="image/*" style="display:none">

    <!-- CROP MODAL -->
    <div id="cropOv">
        <div class="crop-modal">
            <div class="crop-m-hdr">
                <div class="crop-m-hdr-l">
                    <div class="crop-m-ico">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 2v14a2 2 0 0 0 2 2h14" />
                            <path d="M18 22V8a2 2 0 0 0-2-2H2" />
                        </svg>
                    </div>
                    <div>
                        <div class="crop-m-title">Crop Image</div>
                        <div class="crop-m-sub">Drag the crop box or enter custom dimensions</div>
                    </div>
                </div>
                <button class="crop-m-x" id="cropMX">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <!-- Aspect Ratio Pills -->
            <div class="crop-ar-row" id="cropArRow">
                <button class="car on" data-ar="free">✦ Free</button>
                <button class="car" data-ar="1:1">1:1 Square</button>
                <button class="car" data-ar="4:3">4:3</button>
                <button class="car" data-ar="16:9">16:9</button>
                <button class="car" data-ar="3:2">3:2</button>
                <button class="car" data-ar="2:3">2:3 Portrait</button>
                <button class="car" data-ar="9:16">9:16 Story</button>
                <button class="car" data-ar="3:4">3:4</button>
            </div>
            <div class="crop-canvas-area">
                <!-- Visual crop area -->
                <div class="crop-preview-wrap" id="cropPreviewWrap">
                    <img id="cropPreviewImg" src="" alt="Preview">
                    <div id="cropBox">
                        <div class="crop-grid">
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                            <div class="crop-grid-cell"></div>
                        </div>
                        <div class="crop-corner tl" data-h="tl"></div>
                        <div class="crop-corner tr" data-h="tr"></div>
                        <div class="crop-corner bl" data-h="bl"></div>
                        <div class="crop-corner br" data-h="br"></div>
                        <div class="crop-edge et" data-h="t"></div>
                        <div class="crop-edge eb" data-h="b"></div>
                        <div class="crop-edge el" data-h="l"></div>
                        <div class="crop-edge er" data-h="r"></div>
                    </div>
                </div>
                <!-- Manual size inputs -->
                <div class="crop-manual-row">
                    <div class="crop-inp-group">
                        <label class="crop-inp-lbl">Width (px)</label>
                        <input type="number" class="crop-inp" id="cropWPx" placeholder="Width">
                    </div>
                    <div class="crop-inp-group">
                        <label class="crop-inp-lbl">Height (px)</label>
                        <input type="number" class="crop-inp" id="cropHPx" placeholder="Height">
                    </div>
                </div>
                <div class="crop-manual-row" style="margin-top: -8px;">
                    <div class="crop-inp-group">
                        <label class="crop-inp-lbl">Width (%)</label>
                        <input type="number" class="crop-inp" id="cropW" min="5" max="100" value="100">
                    </div>
                    <div class="crop-inp-group">
                        <label class="crop-inp-lbl">Height (%)</label>
                        <input type="number" class="crop-inp" id="cropH" min="5" max="100" value="100">
                    </div>
                </div>
            </div>
            <div class="crop-m-ftr">
                <button class="crop-cancel" id="cropCancel">Cancel</button>
                <button class="crop-apply" id="cropApply">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                    Apply Crop
                </button>
            </div>
        </div>
    </div>

    <script>
        const CATS = ['All', 'Business', 'Nature', 'Technology', 'Food', 'Travel', 'Abstract', 'Fashion', 'Architecture'];
        const TEMPLATES = [
            { id: 1, cat: 'Business', name: 'Corporate Blue', tags: ['popular', 'minimal'], img: 'https://picsum.photos/seed/biz1/400/300' },
            { id: 2, cat: 'Business', name: 'Team Meeting', tags: ['popular'], img: 'https://picsum.photos/seed/biz2/400/300' },
            { id: 3, cat: 'Business', name: 'Office Space', tags: ['new', 'minimal'], img: 'https://picsum.photos/seed/biz3/400/300' },
            { id: 4, cat: 'Business', name: 'Dark Dashboard', tags: ['dark'], img: 'https://picsum.photos/seed/biz4/400/300' },
            { id: 5, cat: 'Business', name: 'Brand Report', tags: ['new', 'colorful'], img: 'https://picsum.photos/seed/biz5/400/300' },
            { id: 6, cat: 'Business', name: 'Pitch Deck', tags: ['popular', 'colorful'], img: 'https://picsum.photos/seed/biz6/400/300' },
            { id: 7, cat: 'Nature', name: 'Forest Path', tags: ['popular', 'minimal'], img: 'https://picsum.photos/seed/nat1/400/300' },
            { id: 8, cat: 'Nature', name: 'Ocean Sunset', tags: ['colorful'], img: 'https://picsum.photos/seed/nat2/400/300' },
            { id: 9, cat: 'Nature', name: 'Mountain Vista', tags: ['popular'], img: 'https://picsum.photos/seed/nat3/400/300' },
            { id: 10, cat: 'Nature', name: 'Flower Fields', tags: ['new', 'colorful'], img: 'https://picsum.photos/seed/nat4/400/300' },
            { id: 11, cat: 'Nature', name: 'Desert Dunes', tags: ['minimal'], img: 'https://picsum.photos/seed/nat5/400/300' },
            { id: 12, cat: 'Nature', name: 'Dark Forest', tags: ['dark'], img: 'https://picsum.photos/seed/nat6/400/300' },
            { id: 13, cat: 'Technology', name: 'Circuit Board', tags: ['dark', 'popular'], img: 'https://picsum.photos/seed/tec1/400/300' },
            { id: 14, cat: 'Technology', name: 'Code Screen', tags: ['dark'], img: 'https://picsum.photos/seed/tec2/400/300' },
            { id: 15, cat: 'Technology', name: 'Neon Lights', tags: ['colorful', 'dark'], img: 'https://picsum.photos/seed/tec3/400/300' },
            { id: 16, cat: 'Technology', name: 'Future Robot', tags: ['new'], img: 'https://picsum.photos/seed/tec4/400/300' },
            { id: 17, cat: 'Technology', name: 'Data Flow', tags: ['minimal'], img: 'https://picsum.photos/seed/tec5/400/300' },
            { id: 18, cat: 'Food', name: 'Fresh Salad', tags: ['colorful', 'popular'], img: 'https://picsum.photos/seed/foo1/400/300' },
            { id: 19, cat: 'Food', name: 'Artisan Coffee', tags: ['minimal', 'popular'], img: 'https://picsum.photos/seed/foo2/400/300' },
            { id: 20, cat: 'Food', name: 'Rustic Bread', tags: ['new'], img: 'https://picsum.photos/seed/foo3/400/300' },
            { id: 21, cat: 'Food', name: 'Pasta Night', tags: ['colorful'], img: 'https://picsum.photos/seed/foo4/400/300' },
            { id: 22, cat: 'Food', name: 'Dessert Plate', tags: ['new', 'colorful'], img: 'https://picsum.photos/seed/foo5/400/300' },
            { id: 23, cat: 'Travel', name: 'Paris Streets', tags: ['popular'], img: 'https://picsum.photos/seed/tra1/400/300' },
            { id: 24, cat: 'Travel', name: 'Tokyo Nights', tags: ['dark', 'colorful'], img: 'https://picsum.photos/seed/tra2/400/300' },
            { id: 25, cat: 'Travel', name: 'Bali Temple', tags: ['new'], img: 'https://picsum.photos/seed/tra3/400/300' },
            { id: 26, cat: 'Travel', name: 'NYC Skyline', tags: ['popular', 'minimal'], img: 'https://picsum.photos/seed/tra4/400/300' },
            { id: 27, cat: 'Travel', name: 'Safari', tags: ['colorful'], img: 'https://picsum.photos/seed/tra5/400/300' },
            { id: 28, cat: 'Abstract', name: 'Gradient Mesh', tags: ['colorful', 'popular'], img: 'https://picsum.photos/seed/abs1/400/300' },
            { id: 29, cat: 'Abstract', name: 'Dark Waves', tags: ['dark'], img: 'https://picsum.photos/seed/abs2/400/300' },
            { id: 30, cat: 'Abstract', name: 'Geo Minimal', tags: ['minimal'], img: 'https://picsum.photos/seed/abs3/400/300' },
            { id: 31, cat: 'Abstract', name: 'Neon Splash', tags: ['colorful', 'dark'], img: 'https://picsum.photos/seed/abs4/400/300' },
            { id: 32, cat: 'Abstract', name: 'Blueprint', tags: ['minimal', 'new'], img: 'https://picsum.photos/seed/abs5/400/300' },
            { id: 33, cat: 'Fashion', name: 'Runway Look', tags: ['popular', 'new'], img: 'https://picsum.photos/seed/fas1/400/300' },
            { id: 34, cat: 'Fashion', name: 'Monochrome', tags: ['minimal', 'dark'], img: 'https://picsum.photos/seed/fas2/400/300' },
            { id: 35, cat: 'Fashion', name: 'Vibrant Palette', tags: ['colorful'], img: 'https://picsum.photos/seed/fas3/400/300' },
            { id: 36, cat: 'Fashion', name: 'Street Style', tags: ['popular'], img: 'https://picsum.photos/seed/fas4/400/300' },
            { id: 37, cat: 'Architecture', name: 'Glass Tower', tags: ['minimal', 'popular'], img: 'https://picsum.photos/seed/arc1/400/300' },
            { id: 38, cat: 'Architecture', name: 'Old Cathedral', tags: ['new'], img: 'https://picsum.photos/seed/arc2/400/300' },
            { id: 39, cat: 'Architecture', name: 'Brutalist Facade', tags: ['dark', 'minimal'], img: 'https://picsum.photos/seed/arc3/400/300' },
            { id: 40, cat: 'Architecture', name: 'Colorful Houses', tags: ['colorful'], img: 'https://picsum.photos/seed/arc4/400/300' },
        ];

        // ── STATE ──
        let selIds = new Set(), curCat = 'All', curFil = 'all', srchQ = '';
        let layers = [], activeUid = null, uidCtr = 0, replaceMode = false;
        let pages = [], activePageId = null, pageCtr = 0;
        let isTextMode = false;

        // ── HISTORY SYSTEM ──
        const history = {
            undoStack: [],
            redoStack: [],
            maxSize: 100,
            save() {
                const snapshot = JSON.stringify({
                    layers: layers,
                    pages: pages,
                    activePageId: activePageId,
                    activeUid: activeUid,
                    uidCtr: uidCtr,
                    pageCtr: pageCtr
                });
                if (this.undoStack.length > 0 && this.undoStack[this.undoStack.length - 1] === snapshot) return;
                this.undoStack.push(snapshot);
                if (this.undoStack.length > this.maxSize) this.undoStack.shift();
                this.redoStack = [];
                this.updateUI();
            },
            undo() {
                if (this.undoStack.length <= 1) return;
                const current = this.undoStack.pop();
                this.redoStack.push(current);
                const prev = this.undoStack[this.undoStack.length - 1];
                this.restore(prev);
                toast('Undo ↩️');
            },
            redo() {
                if (this.redoStack.length === 0) return;
                const next = this.redoStack.pop();
                this.undoStack.push(next);
                this.restore(next);
                toast('Redo ↪️');
            },
            restore(snapshot) {
                const data = JSON.parse(snapshot);
                layers = data.layers;
                pages = data.pages;
                activePageId = data.activePageId;
                activeUid = data.activeUid;
                uidCtr = data.uidCtr;
                pageCtr = data.pageCtr;

                // Do not restore canvas size automatically on undo, 
                // but we still need to build the layer if it was destroyed or if switching pages.
                // However, the user wants the size to NOT change during undo.

                const curPg = pages.find(p => p.id === activePageId);
                if (curPg) {
                    const cl = document.getElementById('cLayer');
                    const w = cl ? (cl.dataset.w || 1920) : (curPg.canvas.width || 1920);
                    const h = cl ? (cl.dataset.h || 1080) : (curPg.canvas.height || 1080);
                    buildLayer(w, h);
                }
                refreshGrid();
                renderLayerList();
                renderPageList();
                updateProps();
                this.updateUI();
            },
            updateUI() {
                const btnUndo = document.getElementById('btnUndo');
                const btnRedo = document.getElementById('btnRedo');
                if (btnUndo) btnUndo.classList.toggle('disabled', this.undoStack.length <= 1);
                if (btnRedo) btnRedo.classList.toggle('disabled', this.redoStack.length === 0);
            }
        };

        function fitTextAdaptive(lyr) {
            if (lyr.type !== 'text') return;
            const cl = document.getElementById('cLayer');
            if (!cl) return;
            const cw = cl.offsetWidth;
            const ch = cl.offsetHeight;
            const p = lyr.props;

            const temp = document.createElement('div');
            document.body.appendChild(temp);

            function getH(fs) {
                temp.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    width: ${(p.width * cw) / 100}px;
                    font-size: ${fs}px;
                    font-family: ${p.fontFamily === 'inherit' ? "'DM Sans', sans-serif" : p.fontFamily};
                    line-height: ${p.lineHeight};
                    letter-spacing: ${p.letterSpacing}px;
                    font-weight: ${p.bold ? 'bold' : 'normal'};
                    font-style: ${p.italic ? 'italic' : 'normal'};
                    white-space: pre-wrap;
                    word-break: break-word;
                    padding: 0;
                    box-sizing: border-box;
                    text-align: ${p.textAlign};
                `;
                temp.innerText = lyr.text;
                return temp.offsetHeight;
            }

            let fs = p.fontSize;
            let h = getH(fs);
            const maxAllowedH = ch * 0.95; // 95% of canvas height

            // Reduce font size if it overflows height
            if (h > maxAllowedH) {
                while (h > maxAllowedH && fs > 8) {
                    fs -= 1;
                    h = getH(fs);
                }
            } else {
                // Optional: If height is very small, we could increase font size? 
                // Better not to do that automatically unless requested.
            }

            p.fontSize = fs;
            p.height = (h / ch) * 100 + 1;
            document.body.removeChild(temp);
        }

        function mkLayer(t) {
            return {
                uid: ++uidCtr,
                id: t.id || 'lyr-' + Date.now(),
                type: t.type || 'image',
                img: t.img || '',
                text: t.text || 'Add Text Here...',
                name: t.name || (t.type === 'text' ? 'Text' : 'Layer'),
                props: {
                    rotate: 0,
                    scaleX: 1,
                    scaleY: 1,
                    opacity: 1,
                    offsetX: 25,
                    offsetY: 25,
                    width: 50,
                    height: 50,
                    visible: true,
                    fontSize: 16,
                    color: '#000000',
                    bold: false,
                    italic: false,
                    fontFamily: 'inherit',
                    textAlign: 'center',
                    lineHeight: 1.2,
                    letterSpacing: 0,
                    underline: false,
                    strike: false,
                    textCase: 'none',
                    shadow: false,
                    shadowColor: 'rgba(0,0,0,0.3)',
                    shadowBlur: 4,
                    stroke: false,
                    strokeColor: '#ffffff',
                    strokeWidth: 1,
                    highlight: false,
                    highlightColor: '#ffff00',
                    notepadMode: false
                }
            };
        }

        // ── DOM ──
        const canvas = document.getElementById('canvas');
        const cEmpty = document.getElementById('canvasEmpty');
        const layerImgGrid = document.getElementById('layerImgGrid');
        const layerPlaceholder = document.getElementById('layerPlaceholder');
        const layerWrap = document.getElementById('layerWrap');
        const lvList = document.getElementById('lvList');
        const lvEmpty = document.getElementById('lvEmpty');

        // ── PANEL TABS ──
        document.querySelectorAll('.rp-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.rp-tab').forEach(t => t.classList.remove('on'));
                document.querySelectorAll('.rp-view').forEach(v => v.classList.remove('on'));
                this.classList.add('on');
                document.getElementById('view' + this.dataset.tab).classList.add('on');
            });
        });

        // ── LAYER LIST ──
        function renderLayerList() {
            lvList.querySelectorAll('.lv-item').forEach(e => e.remove());
            lvEmpty.style.display = layers.length === 0 ? '' : 'none';
            [...layers].reverse().forEach(lyr => {
                const el = document.createElement('div');
                el.className = 'lv-item' + (lyr.uid === activeUid ? ' active' : '');
                el.dataset.uid = lyr.uid;
                const thumbContent = lyr.type === 'text'
                    ? `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f0f4ff;color:var(--blue);font-weight:bold;font-size:14px;font-family:serif;">T</div>`
                    : `<img src="${lyr.img}" alt="" style="width:100%;height:100%;object-fit:cover;">`;
                el.innerHTML = `
      <div class="lv-thumb">${thumbContent}</div>
      <div class="lv-info">
        <div class="lv-name">${lyr.name}</div>
        <div class="lv-meta">${lyr.props.visible ? 'Visible' : 'Hidden'} · ${Math.round(lyr.props.opacity * 100)}% opacity · R${lyr.props.rotate}°</div>
      </div>
      <div class="lv-acts">
        <button class="lv-act move-up-btn" title="Move Up" data-uid="${lyr.uid}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
        <button class="lv-act move-down-btn" title="Move Down" data-uid="${lyr.uid}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <button class="lv-act vis-btn" title="${lyr.props.visible ? 'Hide' : 'Show'}" data-uid="${lyr.uid}">
          ${lyr.props.visible
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'}
        </button>
        <button class="lv-act del-btn" title="Delete" data-uid="${lyr.uid}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        </button>
      </div>`;
                el.addEventListener('click', function (e) {
                    if (e.target.closest('.lv-act')) return;
                    selectLayer(lyr.uid);
                    switchTab('Props');
                });
                el.querySelector('.vis-btn').addEventListener('click', function (e) {
                    e.stopPropagation();
                    const l = layers.find(x => x.uid === +this.dataset.uid);
                    if (l) { l.props.visible = !l.props.visible; refreshGrid(); renderLayerList(); }
                });
                el.querySelector('.move-up-btn').addEventListener('click', function (e) {
                    e.stopPropagation();
                    moveLayer(+this.dataset.uid, 1);
                });
                el.querySelector('.move-down-btn').addEventListener('click', function (e) {
                    e.stopPropagation();
                    moveLayer(+this.dataset.uid, -1);
                });
                el.querySelector('.del-btn').addEventListener('click', function (e) {
                    e.stopPropagation();
                    deleteLayer(+this.dataset.uid);
                });
                lvList.appendChild(el);
            });
        }

        function switchTab(name) {
            document.querySelectorAll('.rp-tab').forEach(t => t.classList.toggle('on', t.dataset.tab === name));
            document.querySelectorAll('.rp-view').forEach(v => v.classList.toggle('on', v.id === 'view' + name));
        }

        // ── SELECT ──
        function selectLayer(uid) {
            const isNewSelection = activeUid !== uid;
            if (!isNewSelection) return;

            activeUid = uid;

            // UI Updates
            renderLayerList();
            refreshGrid();
            updateProps();
            switchTab('Props'); // Auto-show properties when a layer is selected

            if (document.getElementById('btnDeleteTop')) {
                document.getElementById('btnDeleteTop').classList.toggle('disabled', !activeUid);
            }

            // High-quality text focus logic
            const lyr = getActive();
            if (lyr && lyr.type === 'text') {
                setTimeout(() => {
                    const node = layerImgGrid.querySelector(`[data-uid="${lyr.uid}"] .lg-text-node`);
                    if (node && document.activeElement !== node) {
                        if (node.innerText === 'Add Text Here...') {
                            node.focus();
                            const selection = window.getSelection();
                            const range = document.createRange();
                            range.selectNodeContents(node);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        } else {
                            setCaretAtEnd(node);
                        }
                    }
                }, 50);
            }
        }
        function setCaretAtEnd(el) {
            if (!el) return;
            el.focus();
            if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
                const range = document.createRange();
                range.selectNodeContents(el);
                range.collapse(false);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
        function getActive() { return layers.find(l => l.uid === activeUid) || null; }

        // ── PAGES SYSTEM ──
        function mkPage() {
            const cl = document.getElementById('cLayer');
            // Default to current canvas size if it exists, else 500x500
            const w = cl ? cl.offsetWidth : 500;
            const h = cl ? cl.offsetHeight : 500;

            return {
                id: ++pageCtr,
                name: 'Page ' + pageCtr,
                layers: [],
                canvas: {
                    width: w,
                    height: h
                }
            };
        }

        function renderPageList() {
            const pgList = document.getElementById('pgList');
            pgList.innerHTML = '';
            pages.forEach((pg, idx) => {
                const el = document.createElement('div');
                el.className = 'lv-item' + (pg.id === activePageId ? ' active' : '');
                el.innerHTML = `
                    <div class="lv-thumb" style="background:#f0f0f0; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:10px;">P${idx + 1}</div>
                    <div class="lv-info">
                        <div class="lv-name" contenteditable="true" data-id="${pg.id}" style="outline:none; padding: 2px 4px; border-radius:4px; transition: background 0.2s;">${pg.name}</div>
                        <div class="lv-meta">${pg.layers.length} Layers · ${pg.canvas.width}x${pg.canvas.height}</div>
                    </div>
                    <div class="lv-acts">
                        <button class="lv-act pg-dup-btn" title="Duplicate Page" data-id="${pg.id}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/><rect x="8" y="8" width="13" height="13" rx="2"/></svg>
                        </button>
                        <button class="lv-act pg-del-btn" title="Delete Page" data-id="${pg.id}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                        </button>
                    </div>
                `;
                el.onclick = (e) => {
                    if (e.target.closest('.lv-act') || e.target.classList.contains('lv-name')) return;
                    selectPage(pg.id);
                };

                const nameEl = el.querySelector('.lv-name');
                nameEl.onblur = () => {
                    pg.name = nameEl.textContent;
                    toast('Page renamed');
                };
                nameEl.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); nameEl.blur(); } };

                el.querySelector('.pg-dup-btn').onclick = (e) => {
                    e.stopPropagation();
                    duplicatePage(pg.id);
                };

                el.querySelector('.pg-del-btn').onclick = (e) => {
                    e.stopPropagation();
                    deletePage(pg.id);
                };
                pgList.appendChild(el);
            });
        }

        function selectPage(id) {
            if (activePageId === id) return;
            // Save current to previous active
            if (activePageId !== null) {
                const prev = pages.find(p => p.id === activePageId);
                if (prev) {
                    prev.layers = JSON.parse(JSON.stringify(layers));
                    const cl = document.getElementById('cLayer');
                    prev.canvas = { width: cl.offsetWidth, height: cl.offsetHeight };
                }
            }

            activePageId = id;
            const cur = pages.find(p => p.id === id);
            layers = JSON.parse(JSON.stringify(cur.layers));
            buildLayer(cur.canvas.width, cur.canvas.height);
            activeUid = null;
            refreshGrid();
            renderLayerList();
            renderPageList();
            updateProps();
            toast('Switched to ' + cur.name);
            history.save();
        }

        function duplicatePage(id) {
            const pg = pages.find(p => p.id === id);
            if (!pg) return;

            // Sync current if it's the active one
            if (activePageId === id) {
                pg.layers = JSON.parse(JSON.stringify(layers));
            }

            const newPg = JSON.parse(JSON.stringify(pg));
            newPg.id = ++pageCtr;
            newPg.name = pg.name + ' (Copy)';

            const idx = pages.findIndex(p => p.id === id);
            pages.splice(idx + 1, 0, newPg);

            selectPage(newPg.id);
            toast('Page duplicated 📑');
            history.save();
        }

        function deletePage(id) {
            if (pages.length <= 1) return toast('At least one page required!', 'error');
            const idx = pages.findIndex(p => p.id === id);
            pages.splice(idx, 1);
            if (activePageId === id) {
                activePageId = null;
                selectPage(pages[0].id);
            } else {
                renderPageList();
            }
            toast('Page deleted');
            history.save();
        }

        // ── SLIDESHOW LOGIC ──
        let slideIdx = 0;
        let slideInterval = null;

        function showSlide(idx) {
            slideIdx = (idx + pages.length) % pages.length;
            const pg = pages[slideIdx];
            const slideContent = document.getElementById('slideContent');
            const slideCounter = document.getElementById('slideCounter');

            slideCounter.textContent = `Page ${slideIdx + 1} / ${pages.length}`;

            // Create New Slide with Fade-In
            const wrap = document.createElement('div');
            wrap.className = 'slide-item';
            wrap.style.cssText = `
                width: ${pg.canvas.width}px;
                height: ${pg.canvas.height}px;
                background: #fff;
                position: absolute;
                transform: translate(-50%, -50%) scale(${Math.min(window.innerWidth * 0.8 / pg.canvas.width, window.innerHeight * 0.8 / pg.canvas.height)});
                left: 50%;
                top: 50%;
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
                border-radius: 4px;
                overflow: hidden;
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
            `;

            pg.layers.forEach(lyr => {
                const el = document.createElement('div');
                el.style.cssText = `
                    position: absolute;
                    width: ${lyr.props.width}%;
                    height: ${lyr.props.height}%;
                    left: ${lyr.props.offsetX}%;
                    top: ${lyr.props.offsetY}%;
                    transform: rotate(${lyr.props.rotate}deg);
                    opacity: ${lyr.props.opacity};
                    overflow: hidden;
                `;

                if (lyr.type === 'text') {
                    const txt = document.createElement('div');
                    txt.style.cssText = `
                        width: 100%; height: 100%; display: flex; 
                        align-items: center; justify-content: center;
                        font-family: ${lyr.props.fontFamily};
                        font-size: ${lyr.props.fontSize}px;
                        color: ${lyr.props.color};
                        font-weight: ${lyr.props.bold ? 'bold' : 'normal'};
                        font-style: ${lyr.props.italic ? 'italic' : 'normal'};
                        text-align: ${lyr.props.textAlign};
                        lineHeight: ${lyr.props.lineHeight};
                        letter-spacing: ${lyr.props.letterSpacing}px;
                        text-decoration: ${(lyr.props.underline ? 'underline ' : '') + (lyr.props.strike ? 'line-through' : '')};
                        text-transform: ${lyr.props.textCase || 'none'};
                    `;
                    txt.textContent = lyr.text;
                    el.appendChild(txt);
                } else {
                    const img = document.createElement('img');
                    img.src = lyr.img;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                    el.appendChild(img);
                }
                wrap.appendChild(el);
            });

            // Remove old slides and add new one
            const oldSlide = slideContent.querySelector('.slide-item');
            if (oldSlide) {
                oldSlide.style.opacity = '0';
                setTimeout(() => oldSlide.remove(), 500);
            }

            slideContent.appendChild(wrap);
            // Trigger reflow for transition
            wrap.offsetHeight;
            wrap.style.opacity = '1';
        }

        document.getElementById('btnSlideshow').onclick = () => {
            if (pages.length === 0) return toast('No pages to show!', 'error');

            // Save current page state first
            if (activePageId !== null) {
                const prev = pages.find(p => p.id === activePageId);
                if (prev) prev.layers = JSON.parse(JSON.stringify(layers));
            }

            document.getElementById('slideOv').style.display = 'flex';
            showSlide(0);
        };

        document.getElementById('slideExit').onclick = () => {
            document.getElementById('slideOv').style.display = 'none';
            clearInterval(slideInterval);
            slideInterval = null;
        };

        document.getElementById('slideNext').onclick = () => showSlide(slideIdx + 1);
        document.getElementById('slidePrev').onclick = () => showSlide(slideIdx - 1);

        document.getElementById('slideAuto').onclick = function () {
            if (slideInterval) {
                clearInterval(slideInterval);
                slideInterval = null;
                this.textContent = 'AutoPlay';
                this.style.background = 'var(--blue)';
            } else {
                slideInterval = setInterval(() => showSlide(slideIdx + 1), 3000);
                this.textContent = 'Stop';
                this.style.background = '#ff4b2b';
            }
        };

        document.getElementById('pgAdd').onclick = () => {
            const p = mkPage();
            pages.push(p);
            selectPage(p.id);
            renderPageList();
            toast('New page created! ✨');
            history.save();
        };

        // Initialize first page
        const firstPage = mkPage();
        pages.push(firstPage);
        activePageId = firstPage.id;
        renderPageList();
        history.save();


        function moveLayer(uid, delta) {
            const idx = layers.findIndex(l => l.uid === uid);
            if (idx === -1) return;
            const newIdx = idx + delta;
            if (newIdx < 0 || newIdx >= layers.length) return;
            const temp = layers[idx];
            layers.splice(idx, 1);
            layers.splice(newIdx, 0, temp);
            refreshGrid();
            renderLayerList();
            toast('Layer stack updated ↕️');
            history.save();
        }

        // ── PROPS ──
        function updateProps() {
            const lyr = getActive();
            const noSel = document.getElementById('noSelMsg');
            const pc = document.getElementById('propsContent');
            if (!lyr) { noSel.style.display = ''; pc.style.display = 'none'; return; }
            noSel.style.display = 'none'; pc.style.display = 'flex';
            document.getElementById('ppImg').src = lyr.type === 'text' ? 'https://via.placeholder.com/40x40?text=T' : lyr.img;
            document.getElementById('ppName').textContent = lyr.name;
            const p = lyr.props;
            setSlider('slRotate', 'valRotate', p.rotate, '°');
            const avgScale = Math.min(200, Math.max(5, Math.round((p.width + p.height) / 2)));
            setSlider('slScale', 'valScale', avgScale, '%');
            setSlider('slOpacity', 'valOpacity', Math.round(p.opacity * 100), '%');
            document.getElementById('btnFlipH').classList.toggle('on', p.scaleX < 0);
            document.getElementById('btnFlipV').classList.toggle('on', p.scaleY < 0);

            // Contextual Toggle
            const secTypo = document.getElementById('secTypography');
            const secImg = document.getElementById('secImage');

            const isText = lyr.type === 'text' || lyr.text !== undefined;

            if (isText) {
                secTypo.style.display = 'block';
                secImg.style.display = 'none';

                document.getElementById('txtFont').value = p.fontFamily;
                setSlider('txtSize', 'valTxtSize', p.fontSize, 'px');
                document.getElementById('txtColor').value = p.color;
                document.getElementById('btnBold').classList.toggle('on', p.bold);
                document.getElementById('btnItalic').classList.toggle('on', p.italic);

                // Alignment toggles
                ['L', 'C', 'R'].forEach(dir => {
                    const btn = document.getElementById('btnAlign' + dir);
                    if (btn) {
                        const tag = dir === 'L' ? 'left' : dir === 'C' ? 'center' : 'right';
                        btn.classList.toggle('on', p.textAlign === tag);
                    }
                });

                document.getElementById('btnUnderline').classList.toggle('on', p.underline);
                document.getElementById('btnStrike').classList.toggle('on', p.strike);

                document.getElementById('btnUpper').classList.toggle('on', p.textCase === 'uppercase');
                document.getElementById('btnLower').classList.toggle('on', p.textCase === 'lowercase');
                document.getElementById('btnCap').classList.toggle('on', p.textCase === 'capitalize');

                // Advanced effects
                document.getElementById('btnShadow').classList.toggle('on', p.shadow);
                document.getElementById('btnStroke').classList.toggle('on', p.stroke);
                document.getElementById('btnHighlight').classList.toggle('on', p.highlight);

                const adv = document.getElementById('advTextControls');
                adv.style.display = (p.shadow || p.stroke || p.highlight) ? 'flex' : 'none';
                document.getElementById('rowShadow').style.display = p.shadow ? 'flex' : 'none';
                document.getElementById('rowStroke').style.display = p.stroke ? 'flex' : 'none';
                document.getElementById('rowHighlight').style.display = p.highlight ? 'flex' : 'none';

                document.getElementById('shadowColor').value = p.shadowColor;
                document.getElementById('shadowBlur').value = p.shadowBlur;
                document.getElementById('strokeColor').value = p.strokeColor;
                document.getElementById('strokeWidth').value = p.strokeWidth;
                document.getElementById('highlightColor').value = p.highlightColor;
            } else {
                secTypo.style.display = 'none';
                secImg.style.display = 'block';
            }
        }
        function setSlider(slId, valId, val, suffix) {
            document.getElementById(slId).value = val;
            document.getElementById(valId).textContent = val + suffix;
        }

        // ── APPLY TRANSFORM ──
        // Applies position/size/rotation to the layer element and syncs the ghost handle overlay.
        function applyTransform(itemEl, p) {
            const contentEl = itemEl.querySelector('img, .lg-text-node');
            if (!contentEl && !itemEl.classList.contains('lh-ghost')) return;

            const fx = p.scaleX < 0 ? -1 : 1;
            const fy = p.scaleY < 0 ? -1 : 1;

            // Apply transform to the element
            Object.assign(itemEl.style, {
                width: p.width + '%',
                height: p.height + '%',
                left: p.offsetX + '%',
                top: p.offsetY + '%',
                opacity: p.opacity,
                visibility: p.visible ? 'visible' : 'hidden',
                transform: `rotate(${p.rotate}deg) scale(${fx},${fy})`
            });

            // Also sync the ghost handle in the overlay (if it exists for this layer)
            const handleOv = document.getElementById('layerHandleOv');
            if (handleOv && itemEl.dataset && itemEl.dataset.uid) {
                const ghost = handleOv.querySelector(`.lh-ghost[data-uid="${itemEl.dataset.uid}"]`);
                if (ghost && ghost !== itemEl) {
                    Object.assign(ghost.style, {
                        width: p.width + '%',
                        height: p.height + '%',
                        left: p.offsetX + '%',
                        top: p.offsetY + '%',
                        visibility: p.visible ? 'visible' : 'hidden',
                        transform: `rotate(${p.rotate}deg) scale(${fx},${fy})`
                    });
                }
            }
        }

        // ── REFRESH GRID ──
        function refreshGrid() {
            layerImgGrid.innerHTML = '';
            document.getElementById('layerHandleOv').innerHTML = '';
            if (layers.length === 0) {
                layerImgGrid.className = 'layer-img-grid';
                layerPlaceholder.style.display = '';
                return;
            }
            layerPlaceholder.style.display = 'none';
            layerImgGrid.className = 'layer-img-grid';


            layers.forEach((lyr, idx) => {
                const item = document.createElement('div');
                const isSelected = lyr.uid === activeUid;
                item.className = 'lg-item' + (isSelected ? ' selected' : '');
                item.dataset.uid = lyr.uid;

                // --- STRICT STACKING LOGIC ---
                // Base: 1 - 500
                // Selected Image: 1000
                // Text Band: 10000+
                // Selected Text: 15000
                let zi = idx + 1;
                if (lyr.type === 'text') {
                    zi += 10000;
                    if (isSelected) zi += 5000;
                } else {
                    if (isSelected) zi += 1000;
                }
                item.style.zIndex = zi;
                item.style.visibility = lyr.props.visible ? '' : 'hidden';
                item.style.pointerEvents = (isTextMode && lyr.type !== 'text') ? 'none' : 'auto';

                const crop = document.createElement('div');
                crop.className = 'lg-crop';

                if (lyr.type === 'text') {
                    const txt = document.createElement('div');
                    txt.className = 'lg-text-node';
                    if (lyr.props.notepadMode) {
                        txt.classList.add('notepad');
                        const lhPx = lyr.props.fontSize * lyr.props.lineHeight;
                        txt.style.setProperty('--lh-px', lhPx + 'px');
                    }

                    // Use rich HTML if available, otherwise plain text
                    if (lyr.html) {
                        txt.innerHTML = lyr.html;
                    } else {
                        txt.innerText = lyr.text;
                    }

                    // Allow editing whenever selected, regardless of "Text Mode" state
                    txt.contentEditable = isSelected;
                    txt.style.width = '100%';
                    txt.style.height = '100%';

                    // Use text-align and box layout instead of flex to prevent cursor jumping/bugs
                    txt.style.display = 'block';
                    txt.style.fontSize = lyr.props.fontSize + 'px';
                    txt.style.textAlign = lyr.props.textAlign;
                    txt.style.lineHeight = lyr.props.lineHeight;
                    txt.style.letterSpacing = lyr.props.letterSpacing + 'px';
                    txt.style.textTransform = lyr.props.textCase || 'none';

                    // Apply uniform styles only when no rich HTML (backward compat)
                    if (!lyr.html) {
                        txt.style.color = lyr.props.color;
                        txt.style.fontWeight = lyr.props.bold ? 'bold' : 'normal';
                        txt.style.fontStyle = lyr.props.italic ? 'italic' : 'normal';
                        txt.style.fontFamily = lyr.props.fontFamily;
                        txt.style.textDecoration = (lyr.props.underline ? 'underline ' : '') + (lyr.props.strike ? 'line-through' : '');
                    }

                    txt.style.textShadow = lyr.props.shadow ? `0 2px ${lyr.props.shadowBlur}px ${lyr.props.shadowColor}` : 'none';
                    txt.style.webkitTextStroke = lyr.props.stroke ? `${lyr.props.strokeWidth}px ${lyr.props.strokeColor}` : 'none';

                    // Gradient/Split text takes priority over background/highlight
                    const g = lyr.props.gradient;
                    if (g && g.on) {
                        let grad;
                        if (g.count === 2) {
                            // Hard 2-color split: top color until 50%, bottom color from 50%
                            grad = `linear-gradient(to bottom, ${g.top} 50%, ${g.btm} 50%)`;
                        } else {
                            // Hard 3-color split: Equally divided into thirds (33.333%)
                            grad = `linear-gradient(to bottom, ${g.top} 33.333%, ${g.mid} 33.333%, ${g.mid} 66.666%, ${g.btm} 66.666%)`;
                        }
                        const lh = lyr.props.lineHeight || 1.6;
                        txt.style.background = grad;
                        txt.style.backgroundSize = `100% ${lh}em`;
                        txt.style.backgroundRepeat = 'repeat';
                        txt.style.backgroundPosition = '0 0.05em';
                        txt.style.webkitBackgroundClip = 'text';
                        txt.style.webkitTextFillColor = 'transparent';
                        txt.style.backgroundClip = 'text';
                        txt.classList.add('split-on');
                    } else {
                        txt.style.background = lyr.props.highlight ? lyr.props.highlightColor : 'transparent';
                        txt.classList.remove('split-on');
                        txt.style.backgroundSize = '';
                        txt.style.backgroundRepeat = '';
                        txt.style.backgroundPosition = '';
                        if (lyr.props.highlight) txt.style.padding = '0 4px';
                        else txt.style.padding = '0';
                    }

                    txt.style.wordBreak = 'break-word';
                    txt.style.whiteSpace = 'pre-wrap';
                    txt.style.outline = 'none';

                    // Always allow pointer events on text so we can select it by clicking
                    txt.style.pointerEvents = 'all';

                    txt.oninput = () => {
                        lyr.text = txt.innerText;
                        lyr.html = txt.innerHTML;
                        lyr.name = txt.innerText.substring(0, 15) || 'Text';
                        fitTextAdaptive(lyr);
                        applyTransform(item, lyr.props);
                        renderLayerList();
                    };

                    crop.appendChild(txt);
                    crop.style.pointerEvents = 'all'; // Allow crop to catch events always for text
                } else {
                    const img = document.createElement('img');
                    img.src = lyr.img; img.alt = lyr.name;
                    img.style.pointerEvents = 'none';
                    crop.appendChild(img);
                    crop.style.pointerEvents = 'none';
                }

                item.append(crop);
                applyTransform(item, lyr.props);

                // ── Handle overlay: place handles in the separate overlay div ──
                // Only create handles for the currently selected layer
                const handleOv = document.getElementById('layerHandleOv');
                if (lyr.uid === activeUid) {
                    const ghost = document.createElement('div');
                    ghost.className = 'lh-ghost';
                    ghost.dataset.uid = lyr.uid;

                    // The handle wrapper (NO ring here — ring stays in the clipped grid only)
                    const hWrap = document.createElement('div');
                    hWrap.className = 'lg-h-wrap';
                    hWrap.style.opacity = '1';

                    // ── LAYER HANDLES (4 Corner System) ──
                    // tl: delete, tr: move, bl: rotate, br: resize
                    const handles = ['tl', 'tr', 'bl', 'br'];
                    handles.forEach(pos => {
                        const rh = document.createElement('div');
                        rh.className = 'rh ' + pos;
                        rh.dataset.pos = pos;
                        rh.style.opacity = '1';

                        if (pos === 'tl') {
                            rh.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                            rh.onclick = (e) => { e.stopPropagation(); deleteLayer(lyr.uid); };
                        } else if (pos === 'tr') {
                            rh.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/></svg>';
                            rh.addEventListener('mousedown', (e) => { e.stopPropagation(); attachMoveDrag(e, lyr, item); });
                            rh.addEventListener('touchstart', (e) => { e.stopPropagation(); attachMoveDrag(e, lyr, item); }, { passive: false });
                        } else if (pos === 'bl') {
                            rh.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 2v6h-6M21 13a9 9 0 1 1-3-7.7"/></svg>';
                            attachRotateDrag(rh, lyr, item);
                        } else if (pos === 'br') {
                            rh.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>';
                            attachResizeDrag(rh, lyr, item);
                        }

                        hWrap.appendChild(rh);
                    });

                    ghost.appendChild(hWrap);
                    // Mirror the item's position/size via the same transform
                    applyTransform(ghost, lyr.props);
                    handleOv.appendChild(ghost);

                    // Also add a selection ring on the item itself (inside the clipped grid)
                    const itemRing = document.createElement('div');
                    itemRing.className = 'lg-ring';
                    itemRing.style.opacity = '1';
                    item.appendChild(itemRing);
                    item.classList.add('selected');
                }

                let lastTap = 0;
                const onStart = e => {
                    if (e.target.classList.contains('rh')) return;
                    if (e.type === 'mousedown' && e.button !== 0) return;

                    const isTouch = e.type === 'touchstart';

                    const item = e.target.closest('.lg-item');
                    if (!item) return;

                    const uid = +item.dataset.uid;
                    const lyr = layers.find(l => l.uid === uid);
                    if (!lyr || !lyr.props.visible) return;

                    // If Text Mode is ON, only allow text layers
                    if (isTextMode && lyr.type !== 'text') return;

                    // ── MOBILE DOUBLE TAP TO SELECT ──
                    if (isTouch) {
                        const now = Date.now();
                        const DOUBLE_TAP_TIMEOUT = 300;

                        if (now - lastTap < DOUBLE_TAP_TIMEOUT) {
                            // Double Tap Detected → Select
                            selectLayer(uid);
                            e.preventDefault();
                        }
                        lastTap = now;
                    }

                    // Single click/tap does NOT select.
                    // Selection only happens via double-tap (touch) or dblclick (mouse).
                };

                const onDblClick = e => {
                    const item = e.target.closest('.lg-item');
                    if (!item) return;
                    const uid = +item.dataset.uid;
                    const lyr = layers.find(l => l.uid === uid);
                    if (!lyr || !lyr.props.visible) return;
                    if (isTextMode && lyr.type !== 'text') return;

                    // Desktop double-click → Select
                    selectLayer(uid);
                };

                item.addEventListener('mousedown', onStart);
                item.addEventListener('touchstart', onStart, { passive: false });
                item.addEventListener('dblclick', onDblClick);

                const zoomFitBtn = document.getElementById('zoomFit');
                const zoomInBtn = document.getElementById('zoomIn');
                const zoomOutBtn = document.getElementById('zoomOut');

                // Zoom controls
                zoomInBtn.onclick = () => updateZoom(10);
                zoomOutBtn.onclick = () => updateZoom(-10);
                zoomFitBtn.onclick = () => { _zoom = 90; applyZoom(); toast('Zoom fit'); };

                layerImgGrid.appendChild(item);
            });
        }

        // ── HIGH PERFORMANCE DRAG & RESIZE ──
        let _raf = null;

        function attachMoveDrag(e, lyr, itemEl) {
            const isTouch = e.type === 'touchstart';
            e.preventDefault();

            const startX = isTouch ? e.touches[0].clientX : e.clientX;
            const startY = isTouch ? e.touches[0].clientY : e.clientY;
            const origX = lyr.props.offsetX, origY = lyr.props.offsetY;
            const parentEl = itemEl.parentElement;
            const rect = parentEl.getBoundingClientRect();
            const p = lyr.props;
            let moved = false;

            itemEl.classList.add('dragging');
            document.body.style.userSelect = 'none';
            document.body.style.cursor = 'grabbing';

            function onMove(me) {
                moved = true;
                const clientX = isTouch ? me.touches[0].clientX : me.clientX;
                const clientY = isTouch ? me.touches[0].clientY : me.clientY;

                if (_raf) cancelAnimationFrame(_raf);
                _raf = requestAnimationFrame(() => {
                    p.offsetX = origX + (clientX - startX) / rect.width * 100;
                    p.offsetY = origY + (clientY - startY) / rect.height * 100;
                    applyTransform(itemEl, p);
                });
            }
            function onUp() {
                if (_raf) cancelAnimationFrame(_raf);
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onUp);
                itemEl.classList.remove('dragging');
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
                if (moved) {
                    renderLayerList();
                    history.save();
                }
            }
            if (isTouch) {
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', onUp);
            } else {
                document.addEventListener('mousemove', onMove, { passive: true });
                document.addEventListener('mouseup', onUp);
            }
        }

        function attachRotateDrag(handle, lyr, itemEl) {
            const onStart = e => {
                const isTouch = e.type === 'touchstart';
                e.preventDefault();
                e.stopPropagation();

                const p = lyr.props;
                const rect = itemEl.parentElement.getBoundingClientRect();

                // Get current center of the item in viewport pixels
                const centerX = rect.left + (p.offsetX + p.width / 2) / 100 * rect.width;
                const centerY = rect.top + (p.offsetY + p.height / 2) / 100 * rect.height;

                function onMove(me) {
                    const clientX = isTouch ? me.touches[0].clientX : me.clientX;
                    const clientY = isTouch ? me.touches[0].clientY : me.clientY;

                    // Simple trig for angle relative to center
                    const angle = Math.atan2(clientY - centerY, clientX - centerX);
                    let deg = angle * (180 / Math.PI) + 90; // +90 because handle is at the top

                    // Snapping (Shift key or auto-snap at 15deg)
                    if (me.shiftKey) deg = Math.round(deg / 15) * 15;

                    if (_raf) cancelAnimationFrame(_raf);
                    _raf = requestAnimationFrame(() => {
                        p.rotate = Math.round(deg);
                        applyTransform(itemEl, p);
                        if (lyr.uid === activeUid) {
                            document.getElementById('valRotate').textContent = p.rotate + '°';
                            document.getElementById('slRotate').value = p.rotate;
                        }
                    });
                }
                function onUp() {
                    cancelAnimationFrame(_raf);
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onUp);
                    renderLayerList();
                    history.save();
                }
                if (isTouch) {
                    document.addEventListener('touchmove', onMove, { passive: false });
                    document.addEventListener('touchend', onUp);
                } else {
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                }
            };
        }

        function attachResizeDrag(handle, lyr, itemEl) {
            const onStart = e => {
                const isTouch = e.type === 'touchstart';
                e.preventDefault(); // Stop scroll and dual firing
                e.stopPropagation();

                const pos = handle.dataset.pos;
                const startX = isTouch ? e.touches[0].clientX : e.clientX;
                const startY = isTouch ? e.touches[0].clientY : e.clientY;
                const p = lyr.props;
                const origW = p.width, origH = p.height, origX = p.offsetX, origY = p.offsetY;
                const rect = itemEl.parentElement.getBoundingClientRect();

                function onMove(me) {
                    const clientX = isTouch ? me.touches[0].clientX : me.clientX;
                    const clientY = isTouch ? me.touches[0].clientY : me.clientY;

                    if (_raf) cancelAnimationFrame(_raf);
                    _raf = requestAnimationFrame(() => {
                        let dx = (clientX - startX) / rect.width * 100;
                        let dy = (clientY - startY) / rect.height * 100;

                        if (pos.includes('l')) { p.width = Math.max(5, origW - dx); p.offsetX = origX + dx; }
                        if (pos.includes('r')) { p.width = Math.max(5, origW + dx); }
                        if (pos.includes('t')) { p.height = Math.max(5, origH - dy); p.offsetY = origY + dy; }
                        if (pos.includes('b')) { p.height = Math.max(5, origH + dy); }

                        applyTransform(itemEl, p);
                        if (lyr.uid === activeUid) {
                            const avgVal = Math.round((p.width + p.height) / 2);
                            document.getElementById('valScale').textContent = avgVal + '%';
                            document.getElementById('slScale').value = avgVal;
                        }
                    });
                }
                function onUp() {
                    cancelAnimationFrame(_raf);
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onUp);
                    renderLayerList();
                    history.save();
                }
                if (isTouch) {
                    document.addEventListener('touchmove', onMove, { passive: false });
                    document.addEventListener('touchend', onUp);
                } else {
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                }
            };
            handle.addEventListener('mousedown', onStart);
            handle.addEventListener('touchstart', onStart, { passive: false });
        }

        // sliders
        document.getElementById('slRotate').addEventListener('input', function () {
            document.getElementById('valRotate').textContent = this.value + '°';
            const l = getActive(); if (!l) return;
            l.props.rotate = +this.value;
            liveUpdate(l);
        });
        document.getElementById('slScale').addEventListener('input', function () {
            document.getElementById('valScale').textContent = this.value + '%';
            const l = getActive(); if (!l) return;
            const sc = +this.value;
            l.props.width = sc; l.props.height = sc;
            liveUpdate(l);
        });
        document.getElementById('slOpacity').addEventListener('input', function () {
            document.getElementById('valOpacity').textContent = this.value + '%';
            const l = getActive(); if (!l) return;
            l.props.opacity = +this.value / 100;
            liveUpdate(l);
        });


        function liveUpdate(lyr) {
            const item = layerImgGrid.querySelector(`[data-uid="${lyr.uid}"]`);
            if (item) applyTransform(item, lyr.props);
            // Throttle sidebar updates or only update on end of interaction
        }

        // transform buttons
        document.getElementById('btnRotL').addEventListener('click', () => { const l = getActive(); if (!l) return; l.props.rotate = (l.props.rotate - 90 + 360) % 360; updateProps(); liveUpdate(l); toast('Rotated −90°'); });
        document.getElementById('btnRotR').addEventListener('click', () => { const l = getActive(); if (!l) return; l.props.rotate = (l.props.rotate + 90) % 360; updateProps(); liveUpdate(l); toast('Rotated +90°'); });
        document.getElementById('btnFlipH').addEventListener('click', () => { const l = getActive(); if (!l) return; l.props.scaleX *= -1; updateProps(); liveUpdate(l); toast('Flipped horizontally'); });
        document.getElementById('btnFlipV').addEventListener('click', () => { const l = getActive(); if (!l) return; l.props.scaleY *= -1; updateProps(); liveUpdate(l); toast('Flipped vertically'); });
        document.getElementById('btnResetT').addEventListener('click', () => {
            const l = getActive(); if (!l) return;
            l.props = { ...l.props, rotate: 0, scaleX: 1, scaleY: 1, offsetX: 0, offsetY: 0, width: 100, height: 100 };
            updateProps(); refreshGrid(); toast('Transform reset');
        });
        document.getElementById('replBtn').addEventListener('click', () => { if (!getActive()) { toast('Select a layer first'); return; } openTmpl(true); });
        document.getElementById('delLayerBtn').addEventListener('click', () => { if (activeUid) deleteLayer(activeUid); });

        function deleteLayer(uid) {
            layers = layers.filter(l => l.uid !== uid);
            if (activeUid === uid) activeUid = null;
            refreshGrid(); renderLayerList(); updateProps();
            if (layers.length === 0) cEmpty.style.display = '';
            toast('Layer deleted');
            if (document.getElementById('btnDeleteTop')) {
                document.getElementById('btnDeleteTop').classList.toggle('disabled', !activeUid);
            }
            history.save();
        }

        // ── TEMPLATE MODAL ──
        const tmov = document.getElementById('tmov');
        const phGrid = document.getElementById('phGrid');
        const catRow = document.getElementById('catRow');
        const srchInput = document.getElementById('srchInput');
        const srchClr = document.getElementById('srchClr');
        const tmAdd = document.getElementById('tmAdd');

        CATS.forEach(c => {
            const t = document.createElement('div'); t.className = 'ct' + (c === 'All' ? ' on' : ''); t.textContent = c;
            t.addEventListener('click', () => { document.querySelectorAll('.ct').forEach(x => x.classList.remove('on')); t.classList.add('on'); curCat = c; renderGrid(); });
            catRow.appendChild(t);
        });
        document.querySelectorAll('.fp').forEach(p => {
            p.addEventListener('click', function () { document.querySelectorAll('.fp').forEach(x => x.classList.remove('on')); this.classList.add('on'); curFil = this.dataset.f; renderGrid(); });
        });
        srchInput.addEventListener('input', function () { srchQ = this.value.trim().toLowerCase(); srchClr.classList.toggle('on', srchQ.length > 0); renderGrid(); });
        srchClr.addEventListener('click', () => { srchInput.value = ''; srchQ = ''; srchClr.classList.remove('on'); srchInput.focus(); renderGrid(); });
        document.getElementById('noResClr').addEventListener('click', resetFilters);

        function resetFilters() {
            srchInput.value = ''; srchQ = ''; srchClr.classList.remove('on'); curCat = 'All'; curFil = 'all';
            document.querySelectorAll('.ct').forEach((x, i) => x.classList.toggle('on', i === 0));
            document.querySelectorAll('.fp').forEach((x, i) => x.classList.toggle('on', i === 0));
            renderGrid();
        }
        function getFiltered() {
            return TEMPLATES.filter(t => {
                const mC = curCat === 'All' || t.cat === curCat;
                const mF = curFil === 'all' || t.tags.includes(curFil);
                const mS = !srchQ || t.name.toLowerCase().includes(srchQ) || t.cat.toLowerCase().includes(srchQ);
                return mC && mF && mS;
            });
        }
        function renderGrid() {
            const items = getFiltered(); phGrid.innerHTML = '';
            document.getElementById('gridTitle').textContent = srchQ ? `"${srchInput.value}"` : curCat === 'All' ? 'All Templates' : curCat;
            if (!items.length) {
                document.getElementById('noRes').classList.add('on'); phGrid.style.display = 'none'; document.getElementById('gridCount').textContent = '';
                document.getElementById('noResMsg').textContent = srchQ ? `No match for "${srchInput.value}".` : 'No templates here.'; return;
            }
            document.getElementById('noRes').classList.remove('on'); phGrid.style.display = 'grid';
            document.getElementById('gridCount').textContent = items.length + ' template' + (items.length !== 1 ? 's' : '');
            items.forEach(t => {
                const el = document.createElement('div');
                el.className = 'ph-item' + (selIds.has(t.id) ? ' on' : '');
                el.innerHTML = `<img src="${t.img}" alt="${t.name}" loading="lazy"><div class="ph-sel-ov"></div><div class="ph-chk"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div><div class="ph-lbl">${t.name}</div>`;
                el.addEventListener('click', () => {
                    if (replaceMode) { selIds.clear(); document.querySelectorAll('.ph-item.on').forEach(x => x.classList.remove('on')); }
                    if (selIds.has(t.id)) { selIds.delete(t.id); el.classList.remove('on'); } else { selIds.add(t.id); el.classList.add('on'); }
                    updateFooter();
                });
                phGrid.appendChild(el);
            });
        }
        function updateFooter() {
            const n = selIds.size;
            document.getElementById('selNum').textContent = n;
            document.getElementById('selBadge').className = 'sel-badge ' + (n > 0 ? 'has' : 'empty');
            document.getElementById('selTxt').textContent = n === 0 ? 'No images selected' : `${n} image${n !== 1 ? 's' : ''} selected`;
            tmAdd.disabled = n === 0;
            const ab = document.getElementById('addBadge');
            if (n > 0) { ab.textContent = n; ab.classList.add('on'); } else ab.classList.remove('on');
        }

        tmAdd.addEventListener('click', () => {
            if (!layerWrap.classList.contains('vis')) buildLayer(1920, 1080);
            if (replaceMode && activeUid) {
                const picked = TEMPLATES.find(t => selIds.has(t.id));
                if (picked) { const l = getActive(); if (l) { l.img = picked.img; l.name = picked.name; } }
            } else {
                TEMPLATES.filter(t => selIds.has(t.id)).forEach(t => layers.push(mkLayer(t)));
            }
            refreshGrid(); renderLayerList(); updateProps();
            const cnt = selIds.size;
            closeTmpl(); selIds.clear(); updateFooter(); cEmpty.style.display = 'none';
            toast(replaceMode ? 'Image replaced 🔄' : `${cnt} layer${cnt !== 1 ? 's' : ''} added 🎉`);
            replaceMode = false;
            history.save();
        });

        function openTmpl(repl = false) {
            replaceMode = repl; selIds.clear(); updateFooter(); renderGrid();
            // update button text
            const btn = tmAdd; btn.innerHTML = '';
            const svgAdd = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
            const svgCheck = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:14px;height:14px"><polyline points="20 6 9 17 4 12"/></svg>';
            btn.innerHTML = repl
                ? `${svgCheck} Replace Image`
                : `${svgAdd} Add to Canvas <span class="badge" id="addBadge">0</span>`;
            btn.disabled = true;
            tmov.classList.add('show');
        }
        function closeTmpl() { tmov.classList.remove('show'); }
        document.getElementById('tmX').addEventListener('click', closeTmpl);
        document.getElementById('tmCancel').addEventListener('click', closeTmpl);
        tmov.addEventListener('click', e => { if (e.target === tmov) closeTmpl(); });
        document.getElementById('sbTmpl').addEventListener('click', () => { activeSb('sbTmpl'); openTmpl(); });
        document.getElementById('mSbTmpl').addEventListener('click', () => { activeMi('mSbTmpl'); openTmpl(); });
        document.getElementById('lvAdd').addEventListener('click', () => openTmpl());

        // ── SIZE MODAL ──
        const sizeOv = document.getElementById('sizeOv');
        const szPresets = document.getElementById('szPresets');
        const szCats = document.querySelectorAll('.sm-cat');

        const szCurrentInfo = document.getElementById('szCurrentInfo');

        function openSize() {
            const cl = document.getElementById('cLayer');
            if (cl) {
                const w = cl.dataset.w || 1920;
                const h = cl.dataset.h || 1080;
                szCurrentInfo.textContent = `Current: ${w}×${h}`;
            }
            sizeOv.classList.add('show');
        }
        function closeSize() { sizeOv.classList.remove('show'); }
        document.getElementById('szX').addEventListener('click', closeSize);
        document.getElementById('szCancel').addEventListener('click', closeSize);
        sizeOv.addEventListener('click', e => { if (e.target === sizeOv) closeSize(); });

        szCats.forEach(catBtn => {
            catBtn.addEventListener('click', () => {
                szCats.forEach(b => b.classList.remove('active'));
                catBtn.classList.add('active');
                const cat = catBtn.dataset.cat;

                const presets = szPresets.querySelectorAll('.spc');
                presets.forEach(p => {
                    if (cat === 'popular' || p.dataset.cat === cat) {
                        p.style.display = 'flex';
                    } else {
                        p.style.display = 'none';
                    }
                });
            });
        });

        szPresets.addEventListener('click', (e) => {
            const spc = e.target.closest('.spc');
            if (spc) {
                szPresets.querySelectorAll('.spc').forEach(x => x.classList.remove('sel'));
                spc.classList.add('sel');
                document.getElementById('szW').value = spc.dataset.w;
                document.getElementById('szH').value = spc.dataset.h;
            }
        });

        ['szW', 'szH'].forEach(id => document.getElementById(id).addEventListener('input', () => szPresets.querySelectorAll('.spc').forEach(x => x.classList.remove('sel'))));
        document.querySelectorAll('.sm-ub').forEach(b => b.addEventListener('click', function () { document.querySelectorAll('.sm-ub').forEach(x => x.classList.remove('active')); this.classList.add('active'); }));
        document.getElementById('szApply').addEventListener('click', () => {
            const w = parseInt(document.getElementById('szW').value) || 1920;
            const h = parseInt(document.getElementById('szH').value) || 1080;
            const unit = document.querySelector('.sm-ub.active').dataset.unit;
            buildLayer(w, h); toast(`Layer set to ${w}×${h} ${unit}`); closeSize();
            history.save();
        });
        function buildLayer(w, h) {
            const aw = canvas.clientWidth - 80, ah = canvas.clientHeight - 80;
            const MW = Math.min(aw, 640), MH = Math.min(ah, 480);
            const r = w / h; let lw, lh;
            if (r > MW / MH) { lw = MW; lh = Math.round(MW / r); } else { lh = MH; lw = Math.round(MH * r); }
            lw = Math.max(lw, 120); lh = Math.max(lh, 80);
            const layer = document.getElementById('cLayer');
            layer.style.width = lw + 'px'; layer.style.height = lh + 'px';
            layer.dataset.w = w; layer.dataset.h = h; // Store original
            layerWrap.classList.remove('vis');
            layerWrap.style.animation = 'none';
            requestAnimationFrame(() => { layerWrap.style.animation = ''; layerWrap.classList.add('vis'); });
            cEmpty.style.display = 'none';
        }

        // Corner resize handles removed
        document.getElementById('sbSize').addEventListener('click', () => { activeSb('sbSize'); openSize(); });
        document.getElementById('mSbSize').addEventListener('click', () => { activeMi('mSbSize'); openSize(); });

        document.getElementById('mSbText').addEventListener('click', () => {
            activeMi('mSbText');
            document.getElementById('sbText').click();
        });
        document.getElementById('mSbUpload').addEventListener('click', () => {
            activeMi('mSbUpload');
            document.getElementById('sbUpload').click();
        });
        document.getElementById('mSbExport').addEventListener('click', () => {
            activeMi('mSbExport');
            document.getElementById('btnExport').click();
        });
        document.getElementById('mSbDocMode').addEventListener('click', () => {
            activeMi('mSbDocMode');
            openDocMode();
        });

        function activeSb(id) {
            document.querySelectorAll('.sb-icon').forEach(x => x.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
            if (id !== 'sbText') {
                isTextMode = false;
                document.body.classList.remove('text-mode-active');
            }
        }
        function activeMi(id) {
            document.querySelectorAll('.mi').forEach(x => x.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
            if (id !== 'mSbText') {
                isTextMode = false;
                document.body.classList.remove('text-mode-active');
            }
        }
        document.querySelectorAll('.sb-icon').forEach(ic => ic.addEventListener('click', function () {
            if (this.id === 'sbSize' || this.id === 'sbTmpl') return;
            document.querySelectorAll('.sb-icon').forEach(x => x.classList.remove('active')); this.classList.add('active');
        }));

        const rpanel = document.getElementById('rpanel'), pov = document.getElementById('pov');
        document.getElementById('panelTog').addEventListener('click', () => rpanel.classList.contains('open') ? (rpanel.classList.remove('open'), pov.classList.remove('show')) : (rpanel.classList.add('open'), pov.classList.add('show')));
        pov.addEventListener('click', () => { rpanel.classList.remove('open'); pov.classList.remove('show'); });

        function toast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'on ' + type;
            clearTimeout(t._t);
            t._t = setTimeout(() => t.classList.remove('on'), 3500);
        }

        setTimeout(() => { document.getElementById('loader').classList.add('gone'); setTimeout(openSize, 450); }, 2200);

        // ── CROP MODAL ──
        const cropOv = document.getElementById('cropOv');
        const cropBox = document.getElementById('cropBox');
        const cropPreviewImg = document.getElementById('cropPreviewImg');
        const cropPreviewWrap = document.getElementById('cropPreviewWrap');
        const cropWInput = document.getElementById('cropW');
        const cropHInput = document.getElementById('cropH');
        const cropWPxInput = document.getElementById('cropWPx');
        const cropHPxInput = document.getElementById('cropHPx');

        // Crop state (all in % relative to the displayed preview area)
        let _cropAR = 'free'; // aspect ratio mode
        // cropRect: x,y,w,h in pixels relative to preview wrap
        let _cropRect = { x: 0, y: 0, w: 100, h: 100 };
        // naturalRect: position and size of image inside wrap (accounting for object-fit:contain)
        let _imgNatRect = { x: 0, y: 0, w: 0, h: 0 };

        function getImgNatRect() {
            const img = cropPreviewImg;
            const wrap = cropPreviewWrap;
            const wW = wrap.clientWidth; const wH = wrap.clientHeight;
            const iW = img.naturalWidth || img.width || wW;
            const iH = img.naturalHeight || img.height || wH;
            const scale = Math.min(wW / iW, wH / iH);
            const dW = iW * scale; const dH = iH * scale;
            const x = (wW - dW) / 2; const y = (wH - dH) / 2;
            return { x, y, w: dW, h: dH };
        }

        function clampCropRect(r) {
            const nr = _imgNatRect;
            r.x = Math.max(nr.x, Math.min(r.x, nr.x + nr.w - r.w));
            r.y = Math.max(nr.y, Math.min(r.y, nr.y + nr.h - r.h));
            r.w = Math.max(nr.w * 0.05, Math.min(r.w, nr.w));
            r.h = Math.max(nr.h * 0.05, Math.min(r.h, nr.h));
            r.x = Math.max(nr.x, Math.min(r.x, nr.x + nr.w - r.w));
            r.y = Math.max(nr.y, Math.min(r.y, nr.y + nr.h - r.h));
            return r;
        }

        function applyARtoCrop() {
            if (_cropAR === 'free') return;
            const [aN, aD] = _cropAR.split(':').map(Number);
            const ratio = aN / aD;
            const nr = _imgNatRect;
            let w = _cropRect.w, h = _cropRect.h;
            // fix width, adjust height
            h = w / ratio;
            if (h > nr.h) { h = nr.h; w = h * ratio; }
            if (w > nr.w) { w = nr.w; h = w / ratio; }
            _cropRect.w = w; _cropRect.h = h;
            clampCropRect(_cropRect);
        }

        function renderCropBox() {
            const r = _cropRect;
            cropBox.style.left = r.x + 'px';
            cropBox.style.top = r.y + 'px';
            cropBox.style.width = r.w + 'px';
            cropBox.style.height = r.h + 'px';
            // update manual inputs
            const nr = _imgNatRect;
            const img = cropPreviewImg;
            cropWInput.value = Math.round(r.w / nr.w * 100);
            cropHInput.value = Math.round(r.h / nr.h * 100);
            if (img.naturalWidth) {
                cropWPxInput.value = Math.round((r.w / nr.w) * img.naturalWidth);
                cropHPxInput.value = Math.round((r.h / nr.h) * img.naturalHeight);
            }
        }

        function initCropBox() {
            _imgNatRect = getImgNatRect();
            const nr = _imgNatRect;
            _cropRect = { x: nr.x, y: nr.y, w: nr.w, h: nr.h };
            applyARtoCrop();
            renderCropBox();
        }

        function openCropModal() {
            const lyr = getActive();
            if (!lyr) { toast('Select a layer first'); return; }
            cropPreviewImg.src = lyr.img;
            _cropAR = 'free';
            document.querySelectorAll('.car').forEach(c => c.classList.toggle('on', c.dataset.ar === 'free'));
            cropPreviewImg.onload = () => { initCropBox(); };
            if (cropPreviewImg.complete && cropPreviewImg.naturalWidth > 0) initCropBox();
            cropOv.classList.add('show');
        }
        function closeCropModal() { cropOv.classList.remove('show'); }

        document.getElementById('cropOpenBtn').addEventListener('click', openCropModal);
        document.getElementById('cropMX').addEventListener('click', closeCropModal);
        document.getElementById('cropCancel').addEventListener('click', closeCropModal);
        cropOv.addEventListener('click', e => { if (e.target === cropOv) closeCropModal(); });

        // Aspect ratio pills
        document.querySelectorAll('.car').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.car').forEach(c => c.classList.remove('on'));
                this.classList.add('on');
                _cropAR = this.dataset.ar;
                applyARtoCrop();
                renderCropBox();
            });
        });

        // Manual input sync
        function manualInputSync(e) {
            const nr = _imgNatRect;
            const img = cropPreviewImg;
            if (!nr.w || !img.naturalWidth) return;

            if (e.target.id === 'cropWPx' || e.target.id === 'cropHPx') {
                let wPx = parseFloat(cropWPxInput.value) || img.naturalWidth;
                let hPx = parseFloat(cropHPxInput.value) || img.naturalHeight;
                _cropRect.w = (wPx / img.naturalWidth) * nr.w;
                _cropRect.h = (hPx / img.naturalHeight) * nr.h;
            } else {
                let wPct = Math.min(100, Math.max(5, parseFloat(cropWInput.value) || 100));
                let hPct = Math.min(100, Math.max(5, parseFloat(cropHInput.value) || 100));
                _cropRect.w = nr.w * wPct / 100;
                _cropRect.h = nr.h * hPct / 100;
            }

            _cropRect.x = nr.x + (nr.w - _cropRect.w) / 2;
            _cropRect.y = nr.y + (nr.h - _cropRect.h) / 2;
            if (_cropAR !== 'free') applyARtoCrop();
            clampCropRect(_cropRect);
            renderCropBox();
        }
        cropWInput.addEventListener('input', manualInputSync);
        cropHInput.addEventListener('input', manualInputSync);
        cropWPxInput.addEventListener('input', manualInputSync);
        cropHPxInput.addEventListener('input', manualInputSync);

        // Drag crop box & handles
        (function () {
            let dragging = false, resizeMode = null;
            let startX, startY, startRect;

            function onCropMouseMove(e) {
                if (!dragging) return;
                const isTouch = e.type.startsWith('touch');
                const clientX = isTouch ? e.touches[0].clientX : e.clientX;
                const clientY = isTouch ? e.touches[0].clientY : e.clientY;

                const nr = _imgNatRect;
                const dx = clientX - startX;
                const dy = clientY - startY;
                const r = { ...startRect };

                if (resizeMode === 'move') {
                    r.x = startRect.x + dx; r.y = startRect.y + dy;
                } else {
                    if (resizeMode.includes('r')) { r.w = Math.max(nr.w * 0.05, startRect.w + dx); }
                    if (resizeMode.includes('l')) { r.w = Math.max(nr.w * 0.05, startRect.w - dx); r.x = startRect.x + (startRect.w - r.w); }
                    if (resizeMode.includes('b')) { r.h = Math.max(nr.h * 0.05, startRect.h + dy); }
                    if (resizeMode.includes('t')) { r.h = Math.max(nr.h * 0.05, startRect.h - dy); r.y = startRect.y + (startRect.h - r.h); }
                    if (_cropAR !== 'free') {
                        const [aN, aD] = _cropAR.split(':').map(Number);
                        const ratio = aN / aD;
                        if (resizeMode.includes('r') || resizeMode.includes('l')) r.h = r.w / ratio;
                        else r.w = r.h * ratio;
                        if (r.w > nr.w) { r.w = nr.w; r.h = r.w / ratio; }
                        if (r.h > nr.h) { r.h = nr.h; r.w = r.h * ratio; }
                    }
                }
                _cropRect = clampCropRect(r);
                renderCropBox();
            }

            function onCropMouseUp() {
                dragging = false;
                document.removeEventListener('mousemove', onCropMouseMove);
                document.removeEventListener('mouseup', onCropMouseUp);
                document.removeEventListener('touchmove', onCropMouseMove);
                document.removeEventListener('touchend', onCropMouseUp);
            }

            function startDrag(e, mode) {
                const isTouch = e.type === 'touchstart';
                if (!isTouch) e.preventDefault();
                e.stopPropagation();

                dragging = true; resizeMode = mode;
                startX = isTouch ? e.touches[0].clientX : e.clientX;
                startY = isTouch ? e.touches[0].clientY : e.clientY;
                startRect = { ..._cropRect };

                if (isTouch) {
                    document.addEventListener('touchmove', onCropMouseMove, { passive: false });
                    document.addEventListener('touchend', onCropMouseUp);
                } else {
                    document.addEventListener('mousemove', onCropMouseMove);
                    document.addEventListener('mouseup', onCropMouseUp);
                }
            }

            const onCropBoxStart = e => {
                if (e.target !== cropBox && !e.target.classList.contains('crop-grid') && !e.target.classList.contains('crop-grid-cell')) return;
                startDrag(e, 'move');
            };
            cropBox.addEventListener('mousedown', onCropBoxStart);
            cropBox.addEventListener('touchstart', onCropBoxStart, { passive: false });

            document.querySelectorAll('.crop-corner, .crop-edge').forEach(el => {
                const onHandleStart = e => startDrag(e, el.dataset.h);
                el.addEventListener('mousedown', onHandleStart);
                el.addEventListener('touchstart', onHandleStart, { passive: false });
            });
        })();

        // Apply Crop
        document.getElementById('cropApply').addEventListener('click', () => {
            const lyr = getActive(); if (!lyr) return;
            const nr = _imgNatRect;
            if (!nr.w || !nr.h) { closeCropModal(); return; }
            // Calculate crop as % of image area
            const cropXPct = (_cropRect.x - nr.x) / nr.w * 100;
            const cropYPct = (_cropRect.y - nr.y) / nr.h * 100;
            const cropWPct = _cropRect.w / nr.w * 100;
            const cropHPct = _cropRect.h / nr.h * 100;
            // Apply to layer props: adjusting offsetX/Y and width/height
            // We store crop as cropX/Y/W/H in % of the *original image*
            // The layer's img is cropped by adjusting the displayed area
            const p = lyr.props;
            // Scale offset within the current layer region
            const origW = p.width, origH = p.height;
            p.offsetX = p.offsetX + (origW * cropXPct / 100);
            p.offsetY = p.offsetY + (origH * cropYPct / 100);
            p.width = origW * cropWPct / 100;
            p.height = origH * cropHPct / 100;
            // Store crop on image transform: shift the img inside .lg-crop
            lyr._cropX = cropXPct;
            lyr._cropY = cropYPct;
            lyr._cropW = cropWPct;
            lyr._cropH = cropHPct;
            refreshGrid(); renderLayerList(); updateProps();
            closeCropModal();
            toast('Crop applied ✂️');
        });

        // Reset crop
        document.getElementById('cropResetBtn').addEventListener('click', () => {
            const lyr = getActive(); if (!lyr) return;
            lyr.props = { ...lyr.props, offsetX: 0, offsetY: 0, width: 100, height: 100 };
            lyr._cropX = lyr._cropY = lyr._cropW = lyr._cropH = undefined;
            refreshGrid(); renderLayerList(); updateProps();
            toast('Crop reset');
        });

        // ── UPLOAD SYSTEM ──
        const sbUpload = document.getElementById('sbUpload');
        const fileInp = document.getElementById('fileInp');
        const canvasEmpty = document.getElementById('canvasEmpty');

        function handleFileUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (event) {
                const dataUrl = event.target.result;
                // Load image to get natural dimensions
                const tempImg = new Image();
                tempImg.onload = function () {
                    const imgW = tempImg.naturalWidth;
                    const imgH = tempImg.naturalHeight;

                    if (!layerWrap.classList.contains('vis')) buildLayer(1920, 1080);

                    // Get canvas dimensions
                    const cLayer = document.getElementById('cLayer');
                    const canvasW = cLayer.offsetWidth || 1920;
                    const canvasH = cLayer.offsetHeight || 1080;

                    // Calculate layer size to fit image fully (contain behavior)
                    const imgRatio = imgW / imgH;
                    const canvasRatio = canvasW / canvasH;
                    let layerWPct, layerHPct;

                    if (imgRatio > canvasRatio) {
                        // Image is wider than canvas ratio — fit by width
                        layerWPct = 90; // 90% of canvas width
                        layerHPct = (layerWPct / imgRatio) * (canvasW / canvasH);
                    } else {
                        // Image is taller than canvas ratio — fit by height
                        layerHPct = 90; // 90% of canvas height
                        layerWPct = (layerHPct * imgRatio) * (canvasH / canvasW);
                    }

                    // Center the layer
                    const offsetX = (100 - layerWPct) / 2;
                    const offsetY = (100 - layerHPct) / 2;

                    const newLyr = mkLayer({
                        id: 'up-' + Date.now(),
                        name: file.name.split('.')[0] || 'Uploaded Image',
                        img: dataUrl
                    });
                    newLyr.props.width = layerWPct;
                    newLyr.props.height = layerHPct;
                    newLyr.props.offsetX = offsetX;
                    newLyr.props.offsetY = offsetY;

                    layers.push(newLyr);
                    activeUid = newLyr.uid;
                    refreshGrid();
                    renderLayerList();
                    updateProps();
                    switchTab('Props');
                    toast('Image uploaded! 🚀');
                };
                tempImg.src = dataUrl;
            };
            reader.readAsDataURL(file);
        }

        sbUpload.onclick = () => fileInp.click();
        canvasEmpty.onclick = () => fileInp.click();
        canvasEmpty.style.cursor = 'pointer';

        fileInp.onchange = e => {
            handleFileUpload(e.target.files[0]);
            fileInp.value = '';
        };

        // ── ZOOM SYSTEM ──
        let _zoom = 100;
        const layerWrapEl = document.getElementById('layerWrap');
        const zoomValEl = document.getElementById('zoomVal');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const zoomFitBtn = document.getElementById('zoomFit');

        function updateZoom(delta) {
            _zoom = Math.min(400, Math.max(10, _zoom + delta));
            applyZoom();
        }

        function applyZoom() {
            layerWrapEl.style.transform = `translate(-50%, -50%) scale(${_zoom / 100})`;
            zoomValEl.textContent = Math.round(_zoom) + '%';
        }

        zoomInBtn.onclick = () => updateZoom(10);
        zoomOutBtn.onclick = () => updateZoom(-10);
        zoomFitBtn.onclick = () => {
            const canvasRect = canvas.getBoundingClientRect();
            const layerRect = document.getElementById('cLayer').getBoundingClientRect();
            // Simple fit logic: reset to 90% if it was too big or small
            _zoom = 90;
            applyZoom();
            toast('Zoom fit');
        };

        const canvasRotateBtn = document.getElementById('canvasRotate');
        canvasRotateBtn.onclick = () => {
            const cl = document.getElementById('cLayer');
            const oldCW = cl.offsetWidth;
            const oldCH = cl.offsetHeight;

            // Swap Workspace Dimensions
            cl.style.width = oldCH + 'px';
            cl.style.height = oldCW + 'px';

            // Transform layers to 90 deg clockwise position, but KEEP content upright
            layers.forEach(l => {
                const p = l.props;
                // Convert current % to pixels relative to old size
                const wPx = (p.width * oldCW) / 100;
                const hPx = (p.height * oldCH) / 100;
                const xPx = (p.offsetX * oldCW) / 100;
                const yPx = (p.offsetY * oldCH) / 100;

                // 90 deg CW coordinate rotation
                const newXPx = oldCH - (yPx + hPx);
                const newYPx = xPx;
                const newWPx = hPx;
                const newHPx = wPx;

                // Convert back to % relative to the NEW size (which is oldCH x oldCW)
                p.width = (newWPx / oldCH) * 100;
                p.height = (newHPx / oldCW) * 100;
                p.offsetX = (newXPx / oldCH) * 100;
                p.offsetY = (newYPx / oldCW) * 100;

                // "not rotate inside image" -> p.rotate is untouched
            });

            refreshGrid();
            renderLayerList();
            updateProps();
            toast('Workspace rotated 90° 🔄', 'success');
            history.save();
        };

        // Wheel to zoom
        canvas.addEventListener('wheel', e => {
            if (e.ctrlKey) {
                e.preventDefault();
                updateZoom(e.deltaY < 0 ? 5 : -5);
            }
        }, { passive: false });

        // ── DESELECT ON BACKGROUND CLICK ──
        canvas.addEventListener('mousedown', e => {
            // If the target is the canvas background or the layer grid (not an item)
            if (e.target === canvas || e.target === layerImgGrid) {
                if (isTextMode) {
                    // Create new text at click spot
                    const rect = layerImgGrid.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / rect.width * 100;
                    const y = (e.clientY - rect.top) / rect.height * 100;

                    const newLyr = mkLayer({
                        type: 'text',
                        text: 'Add Text Here...'
                    });
                    // Center the 50x20 box on the click spot
                    newLyr.props.offsetX = Math.max(0, Math.min(50, x - 25));
                    newLyr.props.offsetY = Math.max(0, Math.min(80, y - 10));
                    newLyr.props.width = 50;
                    newLyr.props.height = 20;

                    fitTextAdaptive(newLyr);
                    layers.push(newLyr);
                    activeUid = newLyr.uid;
                    refreshGrid();
                    renderLayerList();
                    updateProps();

                    // Focus the new text node
                    setTimeout(() => {
                        const node = layerImgGrid.querySelector(`[data-uid="${newLyr.uid}"] .lg-text-node`);
                        if (node) {
                            node.focus();
                            // Select all text
                            const selection = window.getSelection();
                            const range = document.createRange();
                            range.selectNodeContents(node);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                    }, 50);

                    toast('New text created at spot! 🖋️');
                    history.save();
                } else {
                    activeUid = null;
                    refreshGrid();
                    renderLayerList();
                    updateProps();
                }
            }
        });

        // ── PROJECT IMPORT / EXPORT ──
        document.getElementById('btnExport').onclick = () => {
            if (layers.length === 0) return toast('No layers to export!', 'error');
            const project = {
                layers: layers,
                canvas: {
                    width: document.getElementById('cLayer').offsetWidth,
                    height: document.getElementById('cLayer').offsetHeight
                },
                version: '1.0'
            };
            const blob = new Blob([JSON.stringify(project)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'design-project-' + Date.now() + '.json';
            a.click();
            URL.revokeObjectURL(url);
            toast('Project exported successfully 💾', 'success');
        };

        // ── DOC MODE SYSTEM ──
        const docModeOv = document.getElementById('docModeOv');
        const docSheet = document.getElementById('docSheet');

        const docFontSize = document.getElementById('docFontSize');
        const docFontFamily = document.getElementById('docFontFamily');
        const docColor = document.getElementById('docColor');
        const docLineHeight = document.getElementById('docLineHeight');
        const docLetterSpacing = document.getElementById('docLetterSpacing');

        // Helper: check if selection has a specific command state
        function isDocCommandActive(cmd) {
            try { return document.queryCommandState(cmd); } catch (e) { return false; }
        }

        // Helper: update toolbar button highlights based on current selection
        function updateDocToolbar() {
            const setBtn = (id, active) => {
                const b = document.getElementById(id);
                if (b) {
                    b.style.background = active ? 'var(--blue-l)' : 'none';
                    b.style.color = active ? 'var(--blue)' : 'var(--mid)';
                }
            };
            setBtn('docBold', isDocCommandActive('bold'));
            setBtn('docItalic', isDocCommandActive('italic'));
            setBtn('docUnderline', isDocCommandActive('underline'));
            setBtn('docStrike', isDocCommandActive('strikeThrough'));
        }

        // Apply whole-document styles (not per-selection)
        function applyDocWholeStyles() {
            docSheet.style.lineHeight = docLineHeight.value;
            docSheet.style.letterSpacing = docLetterSpacing.value + 'px';
            applyGradientToDoc();
        }

        // ── SELECTION-BASED FORMATTING (execCommand) ──

        // Bold — applies to selected text only
        document.getElementById('docBold').onclick = () => {
            docSheet.focus();
            document.execCommand('bold');
            updateDocToolbar();
        };

        // Italic
        document.getElementById('docItalic').onclick = () => {
            docSheet.focus();
            document.execCommand('italic');
            updateDocToolbar();
        };

        // Underline
        document.getElementById('docUnderline').onclick = () => {
            docSheet.focus();
            document.execCommand('underline');
            updateDocToolbar();
        };

        // Strikethrough
        document.getElementById('docStrike').onclick = () => {
            docSheet.focus();
            document.execCommand('strikeThrough');
            updateDocToolbar();
        };

        // Color — applies to selected text
        docColor.oninput = () => {
            docSheet.focus();
            document.execCommand('foreColor', false, docColor.value);
        };

        // Font Family — applies to selected text
        docFontFamily.onchange = () => {
            docSheet.focus();
            document.execCommand('fontName', false, docFontFamily.value);
        };

        // Font Size — applies to selected text using span wrapper
        docFontSize.oninput = () => {
            const sel = window.getSelection();
            if (!sel.rangeCount || sel.isCollapsed) {
                // No text selected — apply to whole doc
                const cl = document.getElementById('cLayer');
                const ratio = cl ? (docSheet.offsetWidth / cl.offsetWidth) : 1;
                docSheet.style.fontSize = (+docFontSize.value * ratio) + 'px';
                return;
            }
            // Apply font size to selected text
            // execCommand fontSize is limited (1-7), so we use a workaround
            document.execCommand('fontSize', false, '7');
            // Replace <font size="7"> with proper span
            const fonts = docSheet.querySelectorAll('font[size="7"]');
            fonts.forEach(f => {
                const span = document.createElement('span');
                span.style.fontSize = docFontSize.value + 'px';
                span.innerHTML = f.innerHTML;
                f.parentNode.replaceChild(span, f);
            });
        };

        // Line Height — whole doc
        docLineHeight.oninput = applyDocWholeStyles;

        // Letter Spacing — whole doc
        docLetterSpacing.oninput = applyDocWholeStyles;

        // Text Case — applies to whole doc
        document.getElementById('docUpper').onclick = () => {
            const cur = docSheet.style.textTransform;
            docSheet.style.textTransform = cur === 'uppercase' ? 'none' : 'uppercase';
            updateCaseBtns();
        };
        document.getElementById('docLower').onclick = () => {
            const cur = docSheet.style.textTransform;
            docSheet.style.textTransform = cur === 'lowercase' ? 'none' : 'lowercase';
            updateCaseBtns();
        };
        document.getElementById('docCap').onclick = () => {
            const cur = docSheet.style.textTransform;
            docSheet.style.textTransform = cur === 'capitalize' ? 'none' : 'capitalize';
            updateCaseBtns();
        };

        function updateCaseBtns() {
            const tc = docSheet.style.textTransform || 'none';
            const setBtn = (id, active) => {
                const b = document.getElementById(id);
                if (b) { b.style.background = active ? 'var(--blue-l)' : 'none'; b.style.color = active ? 'var(--blue)' : 'var(--mid)'; }
            };
            setBtn('docUpper', tc === 'uppercase');
            setBtn('docLower', tc === 'lowercase');
            setBtn('docCap', tc === 'capitalize');
        }

        // Update toolbar when selection changes inside docSheet
        docSheet.addEventListener('mouseup', updateDocToolbar);
        docSheet.addEventListener('keyup', updateDocToolbar);

        let gradState = {
            on: false,
            count: 2,
            top: '#ffd700',
            mid: '#ff6b6b',
            btm: '#228b22'
        };

        const gradToggle = document.getElementById('docGradToggle');
        const gradTop = document.getElementById('docGradTop');
        const gradMid = document.getElementById('docGradMid');
        const gradBtm = document.getElementById('docGradBtm');
        const gradMidWrap = document.getElementById('docGradMidWrap');

        function buildGradientCSS() {
            if (!gradState.on) return null;

            if (gradState.count === 2) {
                // Hard 2-color split: Exactly 50/50
                return `linear-gradient(to bottom, ${gradState.top} 50%, ${gradState.btm} 50%)`;
            } else {
                // Hard 3-color split: Exactly 33.333/33.333/33.333
                return `linear-gradient(to bottom, ${gradState.top} 33.333%, ${gradState.mid} 33.333%, ${gradState.mid} 66.666%, ${gradState.btm} 66.666%)`;
            }
        }

        function applyGradientToDoc() {
            const grad = buildGradientCSS();
            if (grad) {
                const lh = docLineHeight.value || 1.6;
                docSheet.style.background = grad;
                docSheet.style.backgroundSize = `100% ${lh}em`;
                docSheet.style.backgroundRepeat = 'repeat';
                docSheet.style.backgroundOrigin = 'content-box';
                // Small offset (0.1em) to better center the split on the character body
                docSheet.style.backgroundPosition = '0 0.05em';
                docSheet.style.webkitBackgroundClip = 'text';
                docSheet.style.webkitTextFillColor = 'transparent';
                docSheet.style.backgroundClip = 'text';
                docSheet.classList.add('split-on');
            } else {
                docSheet.style.background = '#fff';
                docSheet.style.backgroundSize = '';
                docSheet.style.backgroundRepeat = '';
                docSheet.style.backgroundOrigin = '';
                docSheet.style.backgroundPosition = '';
                docSheet.style.webkitBackgroundClip = '';
                docSheet.style.webkitTextFillColor = '';
                docSheet.style.backgroundClip = '';
                docSheet.classList.remove('split-on');
            }
        }

        function updateGradUI() {
            gradToggle.style.background = gradState.on ? 'var(--blue-l)' : '#fff';
            gradToggle.style.color = gradState.on ? 'var(--blue)' : 'var(--mid)';
            gradToggle.style.borderColor = gradState.on ? 'var(--blue)' : '#e2e8f0';

            document.getElementById('docSplit2').style.background = gradState.count === 2 ? 'var(--blue-l)' : 'none';
            document.getElementById('docSplit2').style.color = gradState.count === 2 ? 'var(--blue)' : 'var(--mid)';
            document.getElementById('docSplit3').style.background = gradState.count === 3 ? 'var(--blue-l)' : 'none';
            document.getElementById('docSplit3').style.color = gradState.count === 3 ? 'var(--blue)' : 'var(--mid)';

            gradMidWrap.style.display = gradState.count === 3 ? 'flex' : 'none';

            gradTop.value = gradState.top;
            gradMid.value = gradState.mid;
            gradBtm.value = gradState.btm;
        }

        // Toggle
        gradToggle.onclick = () => {
            gradState.on = !gradState.on;
            updateGradUI();
            applyGradientToDoc();
        };

        // Split count
        document.getElementById('docSplit2').onclick = () => { gradState.count = 2; updateGradUI(); applyGradientToDoc(); };
        document.getElementById('docSplit3').onclick = () => { gradState.count = 3; updateGradUI(); applyGradientToDoc(); };

        // Color pickers
        gradTop.oninput = () => { gradState.top = gradTop.value; applyGradientToDoc(); };
        gradMid.oninput = () => { gradState.mid = gradMid.value; applyGradientToDoc(); };
        gradBtm.oninput = () => { gradState.btm = gradBtm.value; applyGradientToDoc(); };

        // ── STROKE & SHADOW ──
        const docStrokeWidth = document.getElementById('docStrokeWidth');
        const docStrokeColor = document.getElementById('docStrokeColor');
        const docShadowBlur = document.getElementById('docShadowBlur');
        const docShadowColor = document.getElementById('docShadowColor');

        function applyEffectsToDoc() {
            const sw = +docStrokeWidth.value;
            const sc = docStrokeColor.value;
            const sb = +docShadowBlur.value;
            const shc = docShadowColor.value;

            docSheet.style.webkitTextStroke = sw > 0 ? `${sw}px ${sc}` : 'none';
            docSheet.style.textShadow = sb > 0 ? `0 2px ${sb}px ${shc}` : 'none';
        }

        docStrokeWidth.oninput = applyEffectsToDoc;
        docStrokeColor.oninput = applyEffectsToDoc;
        docShadowBlur.oninput = applyEffectsToDoc;
        docShadowColor.oninput = applyEffectsToDoc;


        function openDocMode() {
            docModeOv.classList.add('show');

            requestAnimationFrame(() => {
                const cl = document.getElementById('cLayer');
                let ratioToWorkspace = 1;
                if (cl) {
                    const cw = cl.offsetWidth;
                    const ch = cl.offsetHeight;
                    const aspect = cw / ch;

                    const body = document.querySelector('.doc-m-body');
                    const maxBodyW = body.clientWidth - 60;
                    const maxBodyH = body.clientHeight - 60;

                    let finalW, finalH;
                    if (aspect > maxBodyW / maxBodyH) {
                        finalW = maxBodyW;
                        finalH = maxBodyW / aspect;
                    } else {
                        finalH = maxBodyH;
                        finalW = maxBodyH * aspect;
                    }

                    docSheet.style.width = finalW + 'px';
                    docSheet.style.height = finalH + 'px';
                    ratioToWorkspace = finalW / cw;
                }

                const lyr = getActive();
                if (lyr && lyr.type === 'text') {
                    // Load rich HTML if available, otherwise plain text
                    if (lyr.html) {
                        docSheet.innerHTML = lyr.html;
                    } else {
                        docSheet.innerText = lyr.text;
                    }
                    docSheet.style.textAlign = lyr.props.textAlign || 'left';

                    // Populate doc-level controls
                    const fs = lyr.props.fontSize || 16;
                    docFontSize.value = fs;
                    docSheet.style.fontSize = (fs * ratioToWorkspace) + 'px';
                    docLineHeight.value = lyr.props.lineHeight || 1.6;
                    docLetterSpacing.value = lyr.props.letterSpacing || 0;
                    docSheet.style.textTransform = lyr.props.textCase || 'none';
                    docFontFamily.value = lyr.props.fontFamily || 'inherit';
                    docColor.value = lyr.props.color || '#2e3e4e';

                    // Load gradient state
                    if (lyr.props.gradient) {
                        gradState = { ...lyr.props.gradient };
                    } else {
                        gradState = { on: false, count: 2, top: '#ffd700', mid: '#ff6b6b', btm: '#228b22' };
                    }

                    // Stroke & Shadow
                    docStrokeWidth.value = lyr.props.strokeWidth || 0;
                    docStrokeColor.value = lyr.props.strokeColor || '#ffffff';
                    docShadowBlur.value = lyr.props.shadowBlur || 0;
                    docShadowColor.value = lyr.props.shadowColor || '#000000';
                } else {
                    docSheet.innerHTML = '';
                    docSheet.style.textAlign = 'left';
                    docFontSize.value = 16;
                    docSheet.style.fontSize = (16 * ratioToWorkspace) + 'px';
                    docFontFamily.value = 'inherit';
                    docColor.value = '#2e3e4e';
                    docLineHeight.value = 1.6;
                    docLetterSpacing.value = 0;
                    docSheet.style.textTransform = 'none';
                    gradState = { on: false, count: 2, top: '#ffd700', mid: '#ff6b6b', btm: '#228b22' };

                    docStrokeWidth.value = 0;
                    docStrokeColor.value = '#ffffff';
                    docShadowBlur.value = 0;
                    docShadowColor.value = '#000000';
                }

                applyDocWholeStyles();
                updateCaseBtns();
                updateGradUI();
                applyGradientToDoc();
                applyEffectsToDoc();

                // Highlight active alignment
                const align = docSheet.style.textAlign || 'left';
                const map = { 'left': 'L', 'center': 'C', 'right': 'R' };
                ['L', 'C', 'R'].forEach(d => {
                    const b = document.getElementById('docAlign' + d);
                    if (b) {
                        b.style.background = (map[align] === d) ? 'var(--blue-l)' : 'none';
                        b.style.color = (map[align] === d) ? 'var(--blue)' : 'var(--mid)';
                    }
                });

                setTimeout(() => setCaretAtEnd(docSheet), 100);
            });
        }

        function closeDocMode() {
            docModeOv.classList.remove('show');
        }

        ['L', 'C', 'R'].forEach(dir => {
            const btn = document.getElementById('docAlign' + dir);
            btn.onclick = () => {
                const tag = dir === 'L' ? 'left' : dir === 'C' ? 'center' : 'right';
                docSheet.style.textAlign = tag;
                ['L', 'C', 'R'].forEach(d => {
                    const b = document.getElementById('docAlign' + d);
                    if (b) {
                        b.style.background = (d === dir) ? 'var(--blue-l)' : 'none';
                        b.style.color = (d === dir) ? 'var(--blue)' : 'var(--mid)';
                    }
                });
            };
        });

        document.getElementById('sbDocMode').addEventListener('click', () => {
            activeSb('sbDocMode');
            openDocMode();
        });

        document.getElementById('docModeX').addEventListener('click', closeDocMode);
        document.getElementById('docModeCancel').addEventListener('click', closeDocMode);
        docModeOv.addEventListener('click', e => { if (e.target === docModeOv) closeDocMode(); });

        document.getElementById('docModeApply').addEventListener('click', () => {
            const text = docSheet.innerText.trim();
            if (!text) return toast('Please enter some text', 'error');

            const richHtml = docSheet.innerHTML;
            let lyr = getActive();
            const align = docSheet.style.textAlign || 'left';
            const fs = +docFontSize.value;
            const tc = docSheet.style.textTransform || 'none';

            if (lyr && lyr.type === 'text') {
                lyr.text = text;
                lyr.html = richHtml;
                lyr.props.textAlign = align;
                lyr.props.fontSize = fs;
                lyr.props.lineHeight = +docLineHeight.value;
                lyr.props.letterSpacing = +docLetterSpacing.value;
                lyr.props.textCase = tc;
                lyr.props.gradient = { ...gradState };
                lyr.props.stroke = (+docStrokeWidth.value > 0);
                lyr.props.strokeWidth = +docStrokeWidth.value;
                lyr.props.strokeColor = docStrokeColor.value;
                lyr.props.shadow = (+docShadowBlur.value > 0);
                lyr.props.shadowBlur = +docShadowBlur.value;
                lyr.props.shadowColor = docShadowColor.value;
                lyr.name = text.substring(0, 15) || 'Text';
            } else {
                const newLyr = mkLayer({
                    type: 'text',
                    text: text,
                    name: text.substring(0, 15) || 'Text'
                });
                newLyr.html = richHtml;
                newLyr.props.width = 96;
                newLyr.props.height = 30;
                newLyr.props.offsetX = 2;
                newLyr.props.offsetY = 35;
                newLyr.props.textAlign = align;
                newLyr.props.fontSize = fs;
                newLyr.props.lineHeight = +docLineHeight.value;
                newLyr.props.letterSpacing = +docLetterSpacing.value;
                newLyr.props.textCase = tc;
                newLyr.props.gradient = { ...gradState };
                newLyr.props.stroke = (+docStrokeWidth.value > 0);
                newLyr.props.strokeWidth = +docStrokeWidth.value;
                newLyr.props.strokeColor = docStrokeColor.value;
                newLyr.props.shadow = (+docShadowBlur.value > 0);
                newLyr.props.shadowBlur = +docShadowBlur.value;
                newLyr.props.shadowColor = docShadowColor.value;
                layers.push(newLyr);
                activeUid = newLyr.uid;
                lyr = newLyr;
            }

            refreshGrid();
            renderLayerList();
            updateProps();
            closeDocMode();
            cEmpty.style.display = 'none';
            if (!layerWrap.classList.contains('vis')) buildLayer(1920, 1080);
            toast('Applied to Canvas! 📄');
            history.save();
        });

        const importInp = document.getElementById('importInp');
        document.getElementById('btnImport').onclick = () => importInp.click();

        importInp.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const project = JSON.parse(event.target.result);
                    if (project.layers && project.canvas) {
                        layers = project.layers;
                        buildLayer(project.canvas.width, project.canvas.height);
                        refreshGrid();
                        renderLayerList();
                        toast('Project imported! 📁', 'success');
                    } else {
                        throw new Error('Invalid project file');
                    }
                } catch (err) {
                    toast('Failed to import project', 'error');
                }
            };
            reader.readAsText(file);
            importInp.value = '';
        };

        // ── NEW TOOLS ACTIONS ──
        document.getElementById('btnNotepad').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.notepadMode = !l.props.notepadMode;
            updateProps(); refreshGrid(); history.save();
        };

        document.getElementById('btnFitScreen').onclick = () => {
            const l = getActive(); if (!l) return;
            l.props.width = 100; l.props.height = 100;
            l.props.offsetX = 0; l.props.offsetY = 0;
            updateProps(); refreshGrid(); toast('Layer fitted to screen ✨', 'success');
        };

        // oninput for txtContent removed because we edit on-canvas now

        document.getElementById('txtSize').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.fontSize = +this.value;
            document.getElementById('valTxtSize').textContent = this.value + 'px';
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.fontSize = this.value + 'px';
            }
        };

        document.getElementById('txtColor').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.color = this.value;
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.color = this.value;
            }
        };

        document.getElementById('btnBold').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.bold = !l.props.bold;
            updateProps();
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.fontWeight = l.props.bold ? 'bold' : 'normal';
            }
            history.save();
        };

        document.getElementById('btnItalic').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.italic = !l.props.italic;
            updateProps();
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.fontStyle = l.props.italic ? 'italic' : 'normal';
            }
            history.save();
        };

        document.getElementById('btnUnderline').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.underline = !l.props.underline;
            updateProps();
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.textDecoration = (l.props.underline ? 'underline ' : '') + (l.props.strike ? 'line-through' : '');
            }
            history.save();
        };

        document.getElementById('btnStrike').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.strike = !l.props.strike;
            updateProps();
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.textDecoration = (l.props.underline ? 'underline ' : '') + (l.props.strike ? 'line-through' : '');
            }
            history.save();
        };

        ['Upper', 'Lower', 'Cap'].forEach(k => {
            document.getElementById('btn' + k).onclick = function () {
                const l = getActive(); if (!l) return;
                const mode = k === 'Upper' ? 'uppercase' : k === 'Lower' ? 'lowercase' : 'capitalize';
                l.props.textCase = (l.props.textCase === mode) ? 'none' : mode;
                updateProps();
                const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
                if (item) {
                    const node = item.querySelector('.lg-text-node');
                    if (node) node.style.textTransform = l.props.textCase;
                }
                history.save();
            };
        });

        document.querySelectorAll('.pal-col').forEach(pal => {
            pal.onclick = function () {
                const l = getActive(); if (!l) return;
                const col = this.dataset.color;
                l.props.color = col;
                document.getElementById('txtColor').value = col;
                const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
                if (item) {
                    const node = item.querySelector('.lg-text-node');
                    if (node) node.style.color = col;
                }
                history.save();
            };
        });

        document.getElementById('btnShadow').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.shadow = !l.props.shadow;
            updateProps(); refreshGrid(); history.save();
        };
        document.getElementById('shadowColor').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.shadowColor = this.value;
            refreshGrid();
        };
        document.getElementById('shadowColor').onchange = () => history.save();
        document.getElementById('shadowBlur').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.shadowBlur = +this.value;
            refreshGrid();
        };
        document.getElementById('shadowBlur').onchange = () => history.save();

        document.getElementById('btnStroke').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.stroke = !l.props.stroke;
            updateProps(); refreshGrid(); history.save();
        };
        document.getElementById('strokeColor').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.strokeColor = this.value;
            refreshGrid();
        };
        document.getElementById('strokeColor').onchange = () => history.save();
        document.getElementById('strokeWidth').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.strokeWidth = +this.value;
            refreshGrid();
        };
        document.getElementById('strokeWidth').onchange = () => history.save();

        document.getElementById('btnHighlight').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.highlight = !l.props.highlight;
            updateProps(); refreshGrid(); history.save();
        };
        document.getElementById('highlightColor').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.highlightColor = this.value;
            refreshGrid();
        };
        document.getElementById('highlightColor').onchange = () => history.save();

        document.getElementById('txtFont').onchange = function () {
            const l = getActive(); if (!l) return;
            l.props.fontFamily = this.value;
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.fontFamily = this.value;
            }
        };

        ['L', 'C', 'R'].forEach(dir => {
            document.getElementById('btnAlign' + dir).onclick = function () {
                const l = getActive(); if (!l) return;
                const tag = dir === 'L' ? 'left' : dir === 'C' ? 'center' : 'right';
                l.props.textAlign = tag;
                updateProps();
                const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
                if (item) {
                    const node = item.querySelector('.lg-text-node');
                    if (node) node.style.textAlign = tag;
                }
            };
        });

        document.getElementById('txtHeight').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.lineHeight = +this.value;
            document.getElementById('valTxtHeight').textContent = this.value;
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) {
                    node.style.lineHeight = this.value;
                    if (l.props.notepadMode) {
                        const lhPx = l.props.fontSize * +this.value;
                        node.style.setProperty('--lh-px', lhPx + 'px');
                    }
                }
            }
        };

        document.getElementById('txtSpacing').oninput = function () {
            const l = getActive(); if (!l) return;
            l.props.letterSpacing = +this.value;
            document.getElementById('valTxtSpacing').textContent = this.value + 'px';
            const item = layerImgGrid.querySelector(`[data-uid="${l.uid}"]`);
            if (item) {
                const node = item.querySelector('.lg-text-node');
                if (node) node.style.letterSpacing = this.value + 'px';
            }
        };

        // ── VOICE TO TEXT (Legacy removed) ──

        document.getElementById('sbText').onclick = () => {
            isTextMode = !isTextMode;

            if (isTextMode) {
                if (!layerWrap.classList.contains('vis')) buildLayer(1920, 1080);
                activeSb('sbText');
                document.body.classList.add('text-mode-active');

                // Create a NEW centered text layer by default when entering text mode
                const newLyr = mkLayer({
                    type: 'text',
                    text: 'Add Text Here...'
                });
                // Center in area: 50% width at 25% offset
                newLyr.props.offsetX = 25;
                newLyr.props.offsetY = 40;
                newLyr.props.width = 50;
                newLyr.props.height = 20;

                fitTextAdaptive(newLyr);
                layers.push(newLyr);
                selectLayer(newLyr.uid);
                switchTab('Props');

                toast('Text Mode: Centered text added! 🖋️', 'success');
            } else {
                activeSb('sbSize'); // Default back to size tab
                document.body.classList.remove('text-mode-active');
                toast('Selection Mode Active 🖱️');
            }

            refreshGrid();
        };

        document.getElementById('btnNotepad').onclick = function () {
            const l = getActive(); if (!l) return;
            l.props.notepadMode = !l.props.notepadMode;
            this.classList.toggle('on', l.props.notepadMode);
            refreshGrid();
            toast(l.props.notepadMode ? 'Editor Mode: Guide lines enabled 📝' : 'Selection Mode: Guidelines hidden');
            history.save();
        };

        // ── UNDO / REDO / DELETE LISTENERS ──
        document.getElementById('btnUndo').onclick = () => history.undo();
        document.getElementById('btnRedo').onclick = () => history.redo();
        document.getElementById('btnDeleteTop').onclick = () => { if (activeUid) deleteLayer(activeUid); };

        // Save history on property slider change (end of sliding)
        ['slRotate', 'slScale', 'slOpacity', 'txtSize', 'txtHeight', 'txtSpacing'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => history.save());
        });
        // txtContent blur listener removed
        document.getElementById('txtColor').addEventListener('change', () => history.save());
        document.getElementById('txtFont').addEventListener('change', () => history.save());

        // Save history on transform button clicks
        ['btnRotL', 'btnRotR', 'btnFlipH', 'btnFlipV', 'btnResetT', 'btnBold', 'btnItalic'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const oldClick = el.onclick || (() => { });
                el.addEventListener('click', () => history.save());
            }
        });

        // Alignment buttons
        ['L', 'C', 'R'].forEach(dir => {
            const el = document.getElementById('btnAlign' + dir);
            if (el) el.addEventListener('click', () => history.save());
        });

        // Keyboard Shortcuts
        window.addEventListener('keydown', e => {
            // Undo: Ctrl+Z
            if (e.ctrlKey && e.key.toLowerCase() === 'z' && !e.shiftKey) {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.contentEditable !== 'true') {
                    e.preventDefault();
                    history.undo();
                }
            }
            // Redo: Ctrl+Y or Ctrl+Shift+Z
            if ((e.ctrlKey && e.key.toLowerCase() === 'y') || (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'z')) {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.contentEditable !== 'true') {
                    e.preventDefault();
                    history.redo();
                }
            }
            // Delete: Delete key
            if (e.key === 'Delete') {
                if (activeUid && document.activeElement.tagName !== 'INPUT' && document.activeElement.contentEditable !== 'true') {
                    e.preventDefault();
                    deleteLayer(activeUid);
                }
            }
        });

        // Initial history save
        setTimeout(() => history.save(), 3000); 
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // ── DOWNLOAD / EXPORT IMAGE ──
        const onDownload = () => {
            const cLayer = document.getElementById('cLayer');
            if (!cLayer || !document.getElementById('layerWrap').classList.contains('vis')) {
                return toast('Nothing to export yet', 'error');
            }
            toast('Preparing image export\u2026', 'info');
            const selItems = document.querySelectorAll('.lg-item.selected');
            selItems.forEach(el => el.classList.remove('selected'));
            html2canvas(cLayer, {
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false
            }).then(canvas => {
                selItems.forEach(el => el.classList.add('selected'));
                const link = document.createElement('a');
                link.download = 'design-' + Date.now() + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                toast('Image exported! ✨', 'success');
            }).catch(() => {
                selItems.forEach(el => el.classList.add('selected'));
                toast('Export failed', 'error');
            });
        };

        document.getElementById('dlBtn').addEventListener('click', onDownload);
        if (document.getElementById('sbDlBtn')) document.getElementById('sbDlBtn').addEventListener('click', onDownload);
        if (document.getElementById('mSbDownload')) document.getElementById('mSbDownload').addEventListener('click', onDownload);
        // ── EXIT PROTECTION ──
        // This handles browser Refresh / Close Tab
        window.addEventListener('beforeunload', (e) => {
            if (layers.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to exit?';
            }
        });

        // This handles the browser Back / Forward buttons
        // We push a "dummy" state to the history so clicking back triggers popstate instead of leaving
        history.pushState({ entry: true }, "", window.location.href);
        window.addEventListener('popstate', function (event) {
            if (layers.length > 0) {
                // Re-push the state to keep the user on the current page while the alert is up
                history.pushState({ entry: true }, "", window.location.href);

                Swal.fire({
                    title: 'Leave design?',
                    text: "Your changes will be lost if you leave without saving!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3b6ef8',
                    cancelButtonColor: '#a0a5b8',
                    confirmButtonText: 'Yes, leave page',
                    cancelButtonText: 'Stay here',
                    background: '#fff',
                    color: '#1a1d2e',
                    borderRadius: '16px'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // User confirmed. Disable protections and actually go back.
                        window.onbeforeunload = null;
                        history.go(-2); // Skip the dummy state we just added
                    }
                });
            }
        });

        // This handles our custom Exit Button in the UI
        document.getElementById('btnAppExit').onclick = function () {
            Swal.fire({
                title: 'Exit Editor?',
                text: "You will lose any unsaved design changes!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff4b2b',
                cancelButtonColor: '#a0a5b8',
                confirmButtonText: 'Yes, Exit Now',
                cancelButtonText: 'Cancel',
                background: '#fff',
                color: '#1a1d2e',
                borderRadius: '16px'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.onbeforeunload = null;
                    window.location.reload();
                }
            });
        };
    </script>
</body>

</html>